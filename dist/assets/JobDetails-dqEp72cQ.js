import{s as e,j as r,b as t}from"./index-trbIQK5H.js";import{r as a,k as s,u as d,L as o}from"./react-vendor-BmeRVKJv.js";import{f as n}from"./dateUtils-aI21ZMtv.js";import{f as l,a as i}from"./formatUtils-fTiefMj9.js";import{d as c,u as x}from"./AppContent-D46FSUSE.js";import{E as m}from"./pdf-B0g8Z4ek.js";import{P as g}from"./PropertyMap-CbCRsoV1.js";import{I as b}from"./ImageGallery-BxEcHKme.js";import{p as h,o as u,b as p,G as y,I as _,J as f,z as k,x as j,K as w,y as N,N as v,B as C,M as S,e as $,k as P,q as E,r as A,w as F,f as W,F as z,O as D,Q as O,R as I,V as T,W as q,Y,Z as B,_ as J}from"./ui-CiwSAYI4.js";import"./supabase-c3qFLfUQ.js";import"./utils-C_z87yX_.js";import"./leaflet-D5r8Lo0S.js";const R=({recipientEmail:t,ccEmails:s,bccEmails:d,emailContent:o,sendingEmail:n,job:l,onClose:i,onSendEmail:c,onRecipientChange:x,onCCChange:m,onBCCChange:g,onContentChange:b})=>{const[y,_]=a.useState(!1),[f,k]=a.useState(!1),[j,w]=a.useState("visual"),[N,v]=a.useState(!1),[C,S]=a.useState(!1),[$,P]=a.useState(null),E=e=>{const r=e.split("\n");let t="",a=!1,s="",d=!1,o=!1,n=0;for(const l of r){const e=l.trim();if(e.startsWith('<div style="text-align: center'))a=!0,s=l,n=0;else if(a)s+="\n"+l,"</div>"===e&&(t+=s,a=!1,s="",n=0);else if(""===e)n++,1===n&&(t+="<br>");else if("Job Information:"===e)d=!0,n=0,t+=`<div style="margin-top: 16px; margin-bottom: 8px; font-weight: bold; color: #374151;">${e}</div>`;else if("Work Order Information:"===e)d=!1,o=!0,n=0,t+=`<div style="margin-top: 16px; margin-bottom: 8px; font-weight: bold; color: #374151;">${e}</div>`;else if(e.startsWith("â€¢")){n=0;t+=`<div style="margin-left: 20px; margin-bottom: 4px; padding: 6px 10px; background-color: ${d?"#dbeafe":o?"#ecfdf5":"#f3f4f6"}; border-left: 3px solid ${d?"#3b82f6":o?"#10b981":"#6b7280"}; border-radius: 4px;">&bull; ${e.substring(1).trim()}</div>`}else e.startsWith("Dear")||e.startsWith("I hope")||e.startsWith("Please review")||e.startsWith("Thank you")?(n=0,t+=`<div style="margin-bottom: 12px; line-height: 1.5;">${e}</div>`):""!==e&&(n=0,e.startsWith("â€¢")||e.includes("Information:")||(d=!1,o=!1),t+=`<div style="margin-bottom: 8px; line-height: 1.5;">${e}</div>`)}return t},[A,F]=a.useState(null),W=async()=>{if(!A){const r=await(async()=>{if(!l?.id)return null;try{const r=`${l.id}-${Date.now()}-${Math.random().toString(36).substring(2,15)}`,a=new Date(Date.now()+6048e5),s={items:l.work_order?.has_extra_charges?[{description:l.work_order.extra_charges_description||"Additional work required",cost:l.extra_charges_details?.bill_amount||0,hours:l.work_order.extra_hours||0}]:[],total:l.work_order?.has_extra_charges&&l.extra_charges_details?.bill_amount||0,job_details:{id:l.id,work_order_num:l.work_order_num,unit_number:l.unit_number,property:l.property}},{error:d}=await e.from("approval_tokens").insert({job_id:l.id,token:r,approval_type:"extra_charges",extra_charges_data:s,approver_email:t||"pending@example.com",approver_name:l.property?.name||"Property Manager",expires_at:a.toISOString()});return d?null:r}catch(r){return null}})();return r?(F(r),`${window.location.origin}/approval/${r}`):null}return`${window.location.origin}/approval/${A}`};a.useEffect((()=>{l?.id&&z(l.id)}),[l?.id]);const z=async r=>{S(!0);try{const{data:a,error:s}=await e.from("jobs").select("\n          id,\n          work_order_num,\n          unit_number,\n          description,\n          scheduled_date,\n          status,\n          property_id\n        ").eq("id",r).single();if(s)throw s;const{data:d,error:o}=await e.from("properties").select("\n          property_name,\n          address,\n          address_2,\n          city,\n          state,\n          zip,\n          ap_email\n        ").eq("id",a.property_id).single();if(o)throw o;const{data:n,error:l}=await e.from("work_orders").select("\n          id,\n          submission_date,\n          unit_number,\n          is_occupied,\n          is_full_paint,\n          job_category_id,\n          has_sprinklers,\n          sprinklers_painted,\n          painted_ceilings,\n          ceiling_rooms_count,\n          painted_patio,\n          painted_garage,\n          painted_cabinets,\n          painted_crown_molding,\n          painted_front_door,\n          has_accent_wall,\n          accent_wall_type,\n          accent_wall_count,\n          has_extra_charges,\n          extra_charges_description,\n          extra_hours,\n          additional_comments\n        ").eq("job_id",r);if(l)throw l;const i={id:a.id,work_order_num:a.work_order_num,unit_number:a.unit_number,description:a.description,scheduled_date:a.scheduled_date,status:a.status,property:{name:d.property_name,address:d.address,address_2:d.address_2,city:d.city,state:d.state,zip:d.zip,ap_email:d.ap_email},work_orders:n?.map((e=>({id:e.id,submission_date:e.submission_date,unit_number:e.unit_number,is_occupied:e.is_occupied,is_full_paint:e.is_full_paint,job_category:"Work Order",has_sprinklers:e.has_sprinklers,sprinklers_painted:e.sprinklers_painted,painted_ceilings:e.painted_ceilings,ceiling_rooms_count:e.ceiling_rooms_count,painted_patio:e.painted_patio,painted_garage:e.painted_garage,painted_cabinets:e.painted_cabinets,painted_crown_molding:e.painted_crown_molding,painted_front_door:e.painted_front_door,has_accent_wall:e.has_accent_wall,accent_wall_type:e.accent_wall_type,accent_wall_count:e.accent_wall_count,has_extra_charges:e.has_extra_charges,extra_charges_description:e.extra_charges_description,extra_hours:e.extra_hours,additional_comments:e.additional_comments})))||[]};P(i),!t&&d.ap_email&&x(d.ap_email)}catch(a){}finally{S(!1)}},D=async()=>{const e=await(async()=>{const e=await W();if(!e)return"";const r=l?.extra_charges_details?.bill_amount||50*(l?.work_order?.extra_hours||0)||0;return`\n<div style="text-align: center; margin: 30px 0; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">\n  <h3 style="margin: 0 0 15px 0; color: #1f2937;">One-Click Approval</h3>\n  <a href="${e}" \n     style="display: inline-block; background-color: #22c55e; color: white; padding: 15px 30px; \n            text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 16px;\n            margin: 10px 0;">\n    âœ… APPROVE EXTRA CHARGES${r>0?` - $${r.toFixed(2)}`:""}\n  </a>\n  <p style="margin: 15px 0 5px 0; font-size: 14px; color: #6b7280;">\n    Click the button above to approve these charges instantly and move the job to Work Order phase.\n  </p>\n  <p style="margin: 0; font-size: 12px; color: #9ca3af;">\n    Secure link â€¢ Expires in 7 days â€¢ You'll receive confirmation after approval\n  </p>\n</div>`})(),r=l?.work_order_num?`WO-${String(l.work_order_num).padStart(6,"0")}`:"[Work Order]";return`Dear Property Manager,\n\nI hope this email finds you well. I am writing to request your approval for additional charges related to ${r}.\n\n${l?`Job Information:\nâ€¢ Work Order #: ${r}\nâ€¢ Property: ${l.property?.name||"N/A"}\nâ€¢ Address: ${l.property?.address||"N/A"}\nâ€¢ Unit: ${l.unit_number||"N/A"}\nâ€¢ Job Type: ${l.job_type?.label||"N/A"}\nâ€¢ Phase: ${l.job_phase?.label||"N/A"}\nâ€¢ Scheduled Date: ${l.scheduled_date?new Date(l.scheduled_date).toLocaleDateString():"N/A"}\n`:""}\n\n${l?.work_order?`Work Order Information:\nâ€¢ Submission Date: ${l.work_order.submission_date?new Date(l.work_order.submission_date).toLocaleDateString():"N/A"}\nâ€¢ Unit Occupied: ${l.work_order.is_occupied?"Yes":"No"}\nâ€¢ Full Paint: ${l.work_order.is_full_paint?"Yes":"No"}\nâ€¢ Extra Charges: ${l.work_order.has_extra_charges?"Yes":"No"}\nâ€¢ Extra Hours: ${l.work_order.extra_hours||"0"}\nâ€¢ Description: ${l.work_order.extra_charges_description||"N/A"}\n`:""}\n\n${e}\n\nPlease review these charges and let us know if you approve so we can proceed accordingly.\n\nThank you,\nJG Painting Pros Inc.`};return a.useEffect((()=>{(async()=>{if(l&&""===o){const e=await D();b(e)}})()}),[l,o,b]),r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]",children:r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[r.jsxs("div",{className:"flex justify-between items-center mb-4",children:[r.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:"Send Approval Request"}),r.jsx("button",{onClick:i,className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:r.jsx(h,{className:"h-5 w-5"})})]}),r.jsxs("div",{className:"space-y-4",children:[C&&r.jsx("div",{className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4",children:r.jsxs("div",{className:"flex items-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-blue-600 border-t-transparent mr-3"}),r.jsx("span",{className:"text-blue-700 dark:text-blue-300 text-sm",children:"Loading detailed job information..."})]})}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Recipient Email"}),r.jsx("input",{type:"email",value:t,onChange:e=>x(e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white",placeholder:"Enter recipient email"})]}),r.jsxs("div",{children:[r.jsx("button",{type:"button",onClick:()=>v(!N),className:"flex items-center text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300",children:N?r.jsxs(r.Fragment,{children:[r.jsx(u,{className:"h-4 w-4 mr-1"}),"Hide CC/BCC"]}):r.jsxs(r.Fragment,{children:[r.jsx(p,{className:"h-4 w-4 mr-1"}),"Add CC/BCC"]})}),N&&r.jsxs("div",{className:"mt-3 space-y-3",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"CC (optional)"}),r.jsx("input",{type:"text",value:s,onChange:e=>m(e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white",placeholder:"Enter CC emails (comma-separated)"})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"BCC (optional)"}),r.jsx("input",{type:"text",value:d,onChange:e=>g(e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white",placeholder:"Enter BCC emails (comma-separated)"})]})]})]}),r.jsx("div",{className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700/30 rounded-lg p-3 mb-4",children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"text-sm text-blue-800 dark:text-blue-200",children:[r.jsx("strong",{children:"Template:"})," Extra Charges Approval Email"]}),r.jsx("div",{className:"text-xs text-blue-600 dark:text-blue-300",children:"ðŸ’¡ Use Visual tab to see how the email will look to recipients"})]})}),r.jsxs("div",{children:[r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Email Content"}),r.jsxs("div",{className:"flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1",children:[r.jsx("button",{onClick:()=>w("visual"),className:"px-3 py-1 text-xs font-medium rounded-md transition-colors "+("visual"===j?"bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"),children:"Visual"}),r.jsx("button",{onClick:()=>w("code"),className:"px-3 py-1 text-xs font-medium rounded-md transition-colors "+("code"===j?"bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"),children:"Code"})]})]}),"visual"===j?r.jsxs("div",{className:"border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 min-h-[300px] max-h-[400px] overflow-y-auto",children:[r.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 p-3 border-b border-gray-200 dark:border-gray-600 text-xs text-gray-600 dark:text-gray-400",children:[r.jsxs("div",{className:"flex justify-between items-center mb-2",children:[r.jsxs("span",{children:[r.jsx("strong",{children:"To:"})," ",t||"recipient@example.com"]}),r.jsx("span",{className:"text-gray-400",children:"ðŸ“§"})]}),s&&r.jsxs("div",{className:"mb-1",children:[r.jsx("strong",{children:"CC:"})," ",s]}),r.jsxs("div",{children:[r.jsx("strong",{children:"Subject:"})," Extra Charges Approval Request - ",l?.work_order_num?`WO-${String(l.work_order_num).padStart(6,"0")}`:"Work Order"]})]}),r.jsx("div",{className:"p-4",children:r.jsx("div",{className:"text-gray-900 dark:text-gray-100 text-sm leading-relaxed",dangerouslySetInnerHTML:{__html:E(o)}})})]}):r.jsx("textarea",{id:"emailContent",name:"emailContent",value:o,onChange:e=>b(e.target.value),rows:12,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white font-mono text-sm",placeholder:"Email content will be generated automatically..."})]}),r.jsxs("div",{className:"flex justify-end space-x-4",children:[r.jsx("button",{onClick:()=>_(!0),className:"px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600",children:"Preview Email"}),r.jsx("button",{onClick:()=>k(!0),className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm flex items-center",children:"Preview PDF"}),r.jsx("button",{onClick:c,disabled:n,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50",children:n?"Sending...":"Send Email"})]})]}),y&&r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[150]",children:r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[r.jsxs("div",{className:"flex justify-between items-center mb-4",children:[r.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:"Email Preview"}),r.jsx("button",{onClick:()=>_(!1),className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:r.jsx(h,{className:"h-5 w-5"})})]}),r.jsxs("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-4",children:[r.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 p-3 border border-gray-200 dark:border-gray-600 rounded-t-md text-xs text-gray-600 dark:text-gray-400",children:[r.jsxs("div",{className:"flex justify-between items-center mb-2",children:[r.jsxs("span",{children:[r.jsx("strong",{children:"To:"})," ",t||"recipient@example.com"]}),r.jsx("span",{className:"text-gray-400",children:"ðŸ“§"})]}),s&&r.jsxs("div",{className:"mb-1",children:[r.jsx("strong",{children:"CC:"})," ",s]}),r.jsxs("div",{children:[r.jsx("strong",{children:"Subject:"})," Extra Charges Approval Request - ",l?.work_order_num?`WO-${String(l.work_order_num).padStart(6,"0")}`:"Work Order"]})]}),r.jsx("div",{className:"border border-t-0 border-gray-200 dark:border-gray-600 rounded-b-md p-4 bg-white dark:bg-gray-800",children:r.jsx("div",{className:"text-gray-900 dark:text-gray-100 text-sm leading-relaxed",dangerouslySetInnerHTML:{__html:E(o)}})})]})]})}),f&&r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[150]",children:r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[r.jsxs("div",{className:"flex justify-between items-center mb-4",children:[r.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:"PDF Preview"}),r.jsx("button",{onClick:()=>k(!1),className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:"Close"})]}),r.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-4",children:r.jsxs("div",{className:"bg-white p-6 border border-gray-200 rounded-md shadow-sm",style:{fontFamily:"Arial, sans-serif"},children:[r.jsxs("div",{className:"text-center mb-4 pb-4 border-b border-gray-200",children:[r.jsx("h2",{className:"text-lg font-bold text-gray-800",children:"JG Painting Pros Inc."}),r.jsx("p",{className:"text-sm text-gray-600",children:"Extra Charges Approval Request"}),r.jsxs("p",{className:"text-xs text-gray-500",children:["Work Order: ",l?.work_order_num?`WO-${String(l.work_order_num).padStart(6,"0")}`:"N/A"]})]}),r.jsx("div",{className:"text-gray-900 text-sm leading-relaxed",dangerouslySetInnerHTML:{__html:E(o)}}),r.jsxs("div",{className:"mt-6 pt-4 border-t border-gray-200 text-center",children:[r.jsx("p",{className:"text-xs text-gray-500",children:"This document was generated automatically by JG Painting Pros Inc."}),r.jsxs("p",{className:"text-xs text-gray-500",children:["Date: ",(new Date).toLocaleDateString()]})]})]})})]})})]})})},H=({isOpen:s,onClose:d,job:o,notificationType:n,onSent:l})=>{const[i,c]=a.useState(null),[x,m]=a.useState(""),[g,b]=a.useState(""),[k,j]=a.useState(""),[w,N]=a.useState(""),[v,C]=a.useState(""),[S,$]=a.useState(!1),[P,E]=a.useState(!0),[A,F]=a.useState("visual"),[W,z]=a.useState(!1),[D,O]=a.useState(!1);a.useEffect((()=>{s&&o&&(I(),T())}),[s,o,n]);const I=async()=>{try{E(!0);const{data:r,error:t}=await e.from("email_templates").select("*").eq("trigger_phase",n).eq("template_type","notification").single();if(t)throw t;if(c(r),r&&o){const e=q(r.subject,o),t=q(r.body,o);C(e),N(t)}}catch(r){t.error("Failed to load email template")}finally{E(!1)}},T=()=>{m(o?.property?.ap_email?o.property.ap_email:""),b(""),j("")},q=(e,r)=>{if(!e||!r)return e;const t=`${r.property.address}${r.property.address_2?`, ${r.property.address_2}`:""}, ${r.property.city}, ${r.property.state} ${r.property.zip}`,a=r.unit_number||"N/A",s=r.work_order_num?.toString()||r.id.slice(0,8);return e.replace(/\{\{property_address\}\}/g,t).replace(/\{\{unit_number\}\}/g,a).replace(/\{\{job_number\}\}/g,s).replace(/\{\{property_name\}\}/g,r.property.name||t)},Y=e=>{if(!e)return"";const r=e.split("\n");let t="",a=0,s=!1,d=!1;for(const o of r){const e=o.trim();if(""===e)a++,1===a&&(t+="<br>");else if("Job Information:"===e||e.includes("Information:"))s="Job Information:"===e,d="Work Order Information:"===e,a=0,t+=`<div style="margin-top: 16px; margin-bottom: 8px; font-weight: bold; color: #374151;">${e}</div>`;else if(e.startsWith("â€¢")){a=0;t+=`<div style="margin-left: 20px; margin-bottom: 4px; padding: 6px 10px; background-color: ${s?"#dbeafe":d?"#ecfdf5":"#f3f4f6"}; border-left: 3px solid ${s?"#3b82f6":d?"#10b981":"#6b7280"}; border-radius: 4px;">&bull; ${e.substring(1).trim()}</div>`}else e.startsWith("Dear")||e.startsWith("Hello")||e.startsWith("Hi")||e.startsWith("I hope")||e.startsWith("Please")||e.startsWith("Thank you")||e.startsWith("Thanks")?(a=0,t+=`<div style="margin-bottom: 12px; line-height: 1.5;">${e}</div>`):""!==e&&(a=0,e.startsWith("â€¢")||e.includes("Information:")||(s=!1,d=!1),t+=`<div style="margin-bottom: 8px; line-height: 1.5;">${e}</div>`)}return t};return s?r.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]",children:[r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden",children:[r.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700",children:[r.jsxs("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:["Send ",(()=>{switch(n){case"sprinkler_paint":return"Sprinkler Paint";case"drywall_repairs":return"Drywall Repair";default:return"Notification"}})()," Notification"]}),r.jsx("button",{onClick:d,className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300",children:r.jsx(h,{className:"h-6 w-6"})})]}),r.jsx("div",{className:"p-6 overflow-y-auto max-h-[calc(90vh-120px)]",children:P?r.jsxs("div",{className:"flex items-center justify-center py-8",children:[r.jsx(y,{className:"h-8 w-8 animate-spin text-blue-600"}),r.jsx("span",{className:"ml-2 text-gray-600 dark:text-gray-400",children:"Loading template..."})]}):r.jsx("div",{className:"space-y-4",children:r.jsxs("div",{className:"space-y-4",children:[r.jsxs("div",{children:[r.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:["To: ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsx("input",{type:"email",value:x,onChange:e=>m(e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white",placeholder:"recipient@example.com",required:!0})]}),r.jsxs("div",{children:[r.jsx("button",{type:"button",onClick:()=>z(!W),className:"flex items-center text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300",children:W?r.jsxs(r.Fragment,{children:[r.jsx(u,{className:"h-4 w-4 mr-1"}),"Hide CC/BCC"]}):r.jsxs(r.Fragment,{children:[r.jsx(p,{className:"h-4 w-4 mr-1"}),"Add CC/BCC"]})}),W&&r.jsxs("div",{className:"mt-3 space-y-3",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"CC:"}),r.jsx("input",{type:"email",value:g,onChange:e=>b(e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white",placeholder:"cc1@example.com, cc2@example.com"})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"BCC:"}),r.jsx("input",{type:"email",value:k,onChange:e=>j(e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white",placeholder:"bcc1@example.com, bcc2@example.com"})]})]})]}),r.jsxs("div",{children:[r.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:["Subject: ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsx("input",{type:"text",value:v,onChange:e=>C(e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white",required:!0})]}),r.jsxs("div",{children:[r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsxs("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:["Message: ",r.jsx("span",{className:"text-red-500",children:"*"})]}),r.jsxs("div",{className:"flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1",children:[r.jsx("button",{type:"button",onClick:()=>F("visual"),className:"px-3 py-1 text-xs font-medium rounded-md transition-colors "+("visual"===A?"bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"),children:"Visual"}),r.jsx("button",{type:"button",onClick:()=>F("code"),className:"px-3 py-1 text-xs font-medium rounded-md transition-colors "+("code"===A?"bg-white dark:bg-gray-600 text-gray-900 dark:text-white shadow-sm":"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300"),children:"Code"})]})]}),"visual"===A?r.jsxs("div",{className:"border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 min-h-[300px] max-h-[400px] overflow-y-auto",children:[r.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 p-3 border-b border-gray-200 dark:border-gray-600 text-xs text-gray-600 dark:text-gray-400",children:[r.jsxs("div",{className:"flex justify-between items-center mb-2",children:[r.jsxs("span",{children:[r.jsx("strong",{children:"To:"})," ",x||"recipient@example.com"]}),r.jsx("span",{className:"text-gray-400",children:"ðŸ“§"})]}),g&&r.jsxs("div",{className:"mb-1",children:[r.jsx("strong",{children:"CC:"})," ",g]}),r.jsxs("div",{children:[r.jsx("strong",{children:"Subject:"})," ",v||"Notification Subject"]})]}),r.jsx("div",{className:"p-4",children:r.jsx("div",{className:"text-gray-900 dark:text-gray-100 text-sm leading-relaxed",dangerouslySetInnerHTML:{__html:Y(w)}})})]}):r.jsx("textarea",{value:w,onChange:e=>N(e.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white font-mono text-sm",rows:12,required:!0})]}),i?.auto_include_photos&&r.jsx("div",{className:"bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-md p-3",children:r.jsxs("div",{className:"flex items-center",children:[r.jsx(_,{className:"h-5 w-5 text-blue-600 dark:text-blue-400 mr-2"}),r.jsx("span",{className:"text-sm text-blue-800 dark:text-blue-200",children:"Job photos will be automatically included with this notification"})]})})]})})}),r.jsxs("div",{className:"flex justify-end space-x-3 p-6 border-t border-gray-200 dark:border-gray-700",children:[r.jsx("button",{onClick:d,className:"px-4 py-2 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700",disabled:S,children:"Cancel"}),r.jsx("button",{onClick:()=>O(!0),className:"px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600",children:"Preview Email"}),r.jsx("button",{onClick:async()=>{if(o&&x&&w&&v)try{$(!0);const r={to:x,cc:g||void 0,bcc:k||void 0,subject:v,content:w,job_id:o.id,template_type:n};if(i?.auto_include_photos&&o){const{data:t}=await e.from("job_images").select("*").eq("job_id",o.id).order("created_at",{ascending:!1});t&&t.length>0&&(r.content+="\n\n<p><em>Note: Job photos are attached to this email.</em></p>")}const{error:a}=await e.functions.invoke("send-notification-email",{body:r});if(a)throw a;await e.from("email_logs").insert({job_id:o?.id,recipient_email:x,cc_emails:g||null,bcc_emails:k||null,subject:v,template_type:n,sent_at:(new Date).toISOString()}),t.success("Notification sent successfully!"),l?.(),d()}catch(r){t.error("Failed to send notification")}finally{$(!1)}else t.error("Please fill in all required fields")},disabled:S||P||!x||!w||!v,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center",children:S?r.jsxs(r.Fragment,{children:[r.jsx(y,{className:"h-4 w-4 animate-spin mr-2"}),"Sending..."]}):r.jsxs(r.Fragment,{children:[r.jsx(f,{className:"h-4 w-4 mr-2"}),"Send Notification"]})})]})]}),D&&r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[150]",children:r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[r.jsxs("div",{className:"flex justify-between items-center mb-4",children:[r.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:"Email Preview"}),r.jsx("button",{onClick:()=>O(!1),className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:r.jsx(h,{className:"h-5 w-5"})})]}),r.jsxs("div",{className:"border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800",children:[r.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700 p-4 border-b border-gray-200 dark:border-gray-600 text-sm text-gray-600 dark:text-gray-400",children:[r.jsxs("div",{className:"flex justify-between items-center mb-2",children:[r.jsxs("span",{children:[r.jsx("strong",{children:"To:"})," ",x||"recipient@example.com"]}),r.jsx("span",{className:"text-gray-400",children:"ðŸ“§"})]}),g&&r.jsxs("div",{className:"mb-2",children:[r.jsx("strong",{children:"CC:"})," ",g]}),k&&r.jsxs("div",{className:"mb-2",children:[r.jsx("strong",{children:"BCC:"})," ",k]}),r.jsxs("div",{children:[r.jsx("strong",{children:"Subject:"})," ",v||"Notification Subject"]})]}),r.jsx("div",{className:"p-6",children:r.jsx("div",{className:"text-gray-900 dark:text-gray-100 leading-relaxed",dangerouslySetInnerHTML:{__html:Y(w)}})})]})]})})]}):null};function U(){const{jobId:u}=s(),p=d(),{job:y,loading:f,error:U,refetch:M}=function(r){const[t,s]=a.useState(null),[d,o]=a.useState(!0),[n,l]=a.useState(null),i=a.useRef(!0),x=a.useRef(0),m=a.useCallback((async()=>{if(!r)return s(null),void o(!1);const t=Date.now();if(!(t-x.current<5e3)){x.current=t;try{const{data:t,error:a}=await e.rpc("get_job_details",{p_job_id:r});if(a){if("401"===a.code||a.message?.includes("401")){const{data:t,error:d}=await e.from("jobs").select("*").eq("id",r).single();if(d)throw a;if(t)return s(t),void o(!1)}throw a}if(!t)throw new Error("Job not found");let d=null;if(t.assigned_to){const{data:r,error:a}=await e.from("profiles").select("full_name").eq("id",t.assigned_to).single();a||r&&(d=r.full_name)}const n={...t,assigned_to_name:d};i.current&&(s(n),l(null))}catch(a){i.current&&(l(a instanceof Error?a.message:"Failed to fetch job"),s(null))}finally{i.current&&o(!1)}}}),[r]),g=a.useCallback(c((()=>{i.current&&m()}),1e3),[m]);return a.useEffect((()=>{i.current=!0,m();const t=e.channel(`job-${r}`).on("postgres_changes",{event:"*",schema:"public",table:"jobs",filter:`id=eq.${r}`},(e=>{i.current&&g()})).subscribe((e=>{})),a=e.channel(`work-order-${r}`).on("postgres_changes",{event:"*",schema:"public",table:"work_orders",filter:`job_id=eq.${r}`},(e=>{i.current&&g()})).subscribe((e=>{})),s=e.channel(`phase-change-${r}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"job_phase_changes",filter:`job_id=eq.${r}`},(e=>{i.current&&m()})).subscribe((e=>{}));return()=>{i.current=!1,t.unsubscribe(),a.unsubscribe(),s.unsubscribe()}}),[r,m,g]),{job:t,loading:d,error:n,refetch:m}}(u),{phaseChanges:L,loading:G,error:V,refetch:Z}=function(r){const[t,s]=a.useState([]),[d,o]=a.useState(!0),[n,l]=a.useState(null),i=a.useRef(!0),x=a.useRef(0),m=a.useCallback((async()=>{if(!r)return s([]),void o(!1);const t=Date.now();if(!(t-x.current<5e3)){x.current=t;try{const{data:t,error:a}=await e.rpc("get_job_phase_changes",{input_job_id:r});if(a)throw a;i.current&&(s(t||[]),l(null))}catch(a){i.current&&(l(a instanceof Error?a.message:"Failed to fetch phase changes"),s([]))}finally{i.current&&o(!1)}}}),[r]),g=a.useCallback(c((()=>{i.current&&m()}),1e3),[m]);return a.useEffect((()=>{i.current=!0,m();const t=e.channel(`job-${r}-phase-changes`).on("postgres_changes",{event:"*",schema:"public",table:"job_phase_changes",filter:`job_id=eq.${r}`},(()=>{i.current&&g()})).subscribe();return()=>{i.current=!1,t.unsubscribe()}}),[r,m,g]),{phaseChanges:t,loading:d,error:n,refetch:m}}(u),{phases:K,loading:Q}=function(){const[r,t]=a.useState([]),[s,d]=a.useState(!0),[o,n]=a.useState(null),l=a.useRef(!0),i=a.useRef(0),x=a.useCallback((async()=>{const r=Date.now();if(!(r-i.current<1e4)){i.current=r;try{const{data:r,error:a}=await e.from("job_phases").select("*").neq("job_phase_label","Grading").order("sort_order");if(a)throw a;l.current&&(t(r||[]),n(null))}catch(a){l.current&&(n(a instanceof Error?a.message:"Failed to fetch phases"),t([]))}finally{l.current&&d(!1)}}}),[]),m=a.useCallback(c((()=>{l.current&&x()}),1e3),[x]);return a.useEffect((()=>{l.current=!0,x();const r=e.channel("job_phases_changes").on("postgres_changes",{event:"*",schema:"public",table:"job_phases"},(()=>{l.current&&m()})).subscribe();return()=>{l.current=!1,r.unsubscribe()}}),[x,m]),{phases:r,loading:s,error:o,refetch:x}}(),{isAdmin:X,isJGManagement:ee}=x(),[re,te]=a.useState(!1),[ae,se]=a.useState(!1),[de,oe]=a.useState(null),[ne,le]=a.useState(""),[ie,ce]=a.useState(!1),[xe,me]=a.useState(!1),[ge,be]=a.useState(!1),[he,ue]=a.useState(!1),[pe,ye]=a.useState([]),[_e,fe]=a.useState(null),[ke,je]=a.useState(!1),[we,Ne]=a.useState(!1),[ve,Ce]=a.useState(!1),[Se,$e]=a.useState(""),[Pe,Ee]=a.useState(""),[Ae,Fe]=a.useState(""),[We,ze]=a.useState(""),[De,Oe]=a.useState(!0),[Ie,Te]=a.useState(!1),[qe,Ye]=a.useState(!1),[Be,Je]=a.useState(void 0),[Re,He]=a.useState(!1),[Ue,Me]=a.useState(null),[Le,Ge]=a.useState(!1),[Ve,Ze]=a.useState(null);a.useEffect((()=>{}),[y]),a.useEffect((()=>{y?.property?.ap_email&&!Pe&&Ee(y.property.ap_email)}),[y?.property?.ap_email,Pe]),a.useEffect((()=>{(async()=>{if(!y||!u)return;const r=(y.billing_details?.bill_amount??0)+(y.work_order?.has_extra_charges&&y.work_order?.extra_hours?40*y.work_order.extra_hours:0);try{const{error:t}=await e.from("jobs").update({total_billing_amount:r}).eq("id",u);if(t)throw t}catch(t){}})()}),[y,u]),a.useEffect((()=>{y?.assigned_to&&fe(y.assigned_to),Ke()}),[y]),a.useEffect((()=>{(async()=>{if(!y?.work_order||!y?.property?.name)return;const r=`WO-${String(y.work_order_num).padStart(6,"0")}`,t=`/${y.property.name}/Work Orders/${r}`,{data:a,error:s}=await e.from("files").select("id").eq("path",t).eq("type","folder/directory").maybeSingle();!s&&a&&a.id?Me(a.id):Me(null)})()}),[y]);const Ke=async()=>{try{const{data:r,error:t}=await e.from("profiles").select("id, full_name").eq("role","subcontractor").order("full_name");if(t)throw t;ye(r||[])}catch(r){}},Qe=e=>`WO-${String(e).padStart(6,"0")}`;if(f||Q)return r.jsx("div",{className:"flex items-center justify-center h-full",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})});if(U||!y)return r.jsx("div",{className:"p-6 bg-gray-100 dark:bg-[#0F172A]",children:r.jsx("div",{className:"bg-red-50 dark:bg-red-900/50 border border-red-200 dark:border-red-500/50 text-red-700 dark:text-red-200 px-4 py-3 rounded",children:U||"Job not found"})});const Xe=X||ee,er=(X||ee)&&"Job Request"===y.job_phase.label,rr=X&&"Job Request"===y.job_phase.label,tr=X||ee,ar=!!y.work_order,sr="Job Request"===y.job_phase.label,dr="Pending Work Order"===y.job_phase.label;y.job_phase.label;const or="Invoicing"===y.job_phase.label;y.job_phase.label,y.job_phase.label;const nr=null!==y.billing_details?.bill_amount&&null!==y.billing_details?.sub_pay_amount&&void 0!==y.billing_details?.bill_amount&&void 0!==y.billing_details?.sub_pay_amount?y.billing_details.bill_amount-y.billing_details.sub_pay_amount:null,lr=y.extra_charges_details?.bill_amount??0,ir=y.extra_charges_details?.sub_pay_amount??0,cr=y.extra_charges_details?.profit_amount??0;y.extra_charges_details,y.extra_charges_details;const xr=K?K.filter((e=>"Pending Work Order"!==e.job_phase_label)):[],mr=xr.findIndex((e=>e.id===y.job_phase.id)),gr=async r=>{if(r){ce(!0);try{const{data:a,error:s}=await e.auth.getUser();if(s)throw s;if(!a.user)throw new Error("User not found");const{error:d}=await e.from("jobs").update({current_phase_id:r.id}).eq("id",u);if(d)throw d;const{error:o}=await e.from("job_phase_changes").insert([{job_id:u,changed_by:a.user.id,from_phase_id:y.job_phase.id,to_phase_id:r.id,change_reason:`Phase changed by ${a.user.email}`}]);if(o)throw o;await M(),await Z(),t.success("Job phase changed successfully")}catch(a){t.error(a instanceof Error?a.message:"Failed to change job phase")}finally{ce(!1)}}};return r.jsx("div",{className:"p-6 bg-gray-100 dark:bg-[#0F172A] min-h-screen",children:r.jsxs("div",{className:"max-w-7xl mx-auto",children:[r.jsxs("div",{className:"flex items-center justify-between mb-8",children:[r.jsxs("div",{className:"flex items-center space-x-3",children:[r.jsx("button",{onClick:()=>p("/dashboard/jobs"),className:"text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors",children:r.jsx(k,{className:"h-6 w-6"})}),r.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:Qe(y.work_order_num)}),r.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium",style:{backgroundColor:y.job_phase.color_dark_mode,color:"white"},children:y.job_phase.label})]}),r.jsxs("div",{className:"flex space-x-3",children:[Xe&&!dr&&r.jsxs(r.Fragment,{children:[!sr&&r.jsxs("button",{onClick:()=>{mr>0&&gr(xr[mr-1])},disabled:0===mr,className:"inline-flex items-center px-4 py-2 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",style:{backgroundColor:mr>0?xr[mr-1].color_dark_mode:"#6B7280"},children:[r.jsx(k,{className:"h-4 w-4 mr-2"}),"Previous: ",mr>0?xr[mr-1].job_phase_label:"N/A"]}),r.jsxs("button",{onClick:()=>{mr<xr.length-1&&gr(xr[mr+1])},disabled:mr===xr.length-1,className:"inline-flex items-center px-4 py-2 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",style:{backgroundColor:mr<xr.length-1?xr[mr+1].color_dark_mode:"#6B7280"},children:[r.jsx(j,{className:"h-4 w-4 mr-2"}),"Next: ",mr<xr.length-1?xr[mr+1].job_phase_label:"N/A"]})]}),er&&r.jsxs("button",{onClick:()=>p(`/dashboard/jobs/${u}/edit`),className:"inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors",children:[r.jsx(w,{className:"h-4 w-4 mr-2"}),"Edit Job"]}),ar&&r.jsxs(o,{to:`/dashboard/jobs/${u}/new-work-order?edit=true`,className:"inline-flex items-center px-4 py-2 text-white text-sm font-medium rounded-lg transition-colors",style:{backgroundColor:y.job_phase.color_dark_mode},children:[r.jsx(N,{className:"h-4 w-4 mr-2"}),X||ee?"Edit Work Order":"View Work Order"]}),rr&&r.jsxs("button",{onClick:()=>se(!0),className:"inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors",children:[r.jsx(v,{className:"h-4 w-4 mr-2"}),"Delete Job"]})]})]}),r.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6",children:[r.jsxs("div",{className:"lg:col-span-2 bg-white dark:bg-[#1E293B] rounded-lg p-6 shadow-lg",children:[r.jsxs("div",{className:"flex justify-between items-start mb-6",children:[r.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Job Details"}),r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Job Type:"}),r.jsx("span",{className:"text-sm font-medium text-gray-900 dark:text-white",children:y.job_type.label})]})]}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[r.jsxs("div",{children:[r.jsx("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-2",children:"Property"}),r.jsxs("div",{className:"flex items-start",children:[r.jsx(C,{className:"h-5 w-5 text-gray-500 dark:text-gray-400 mt-0.5 mr-2"}),r.jsxs("div",{children:[r.jsx(o,{to:`/dashboard/properties/${y.property.id}`,className:"text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium",children:y.property.name}),r.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:[y.property.address,y.property.address_2&&r.jsxs("span",{children:[", ",y.property.address_2]}),r.jsx("br",{}),y.property.city,", ",y.property.state," ",y.property.zip]})]})]})]}),r.jsxs("div",{children:[r.jsx("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-2",children:"Unit Information"}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex items-center",children:[r.jsx(S,{className:"h-5 w-5 text-gray-500 dark:text-gray-400 mr-2"}),r.jsxs("span",{className:"text-gray-900 dark:text-white",children:["Unit #",y.unit_number]})]}),r.jsxs("div",{className:"flex items-center",children:[r.jsx($,{className:"h-5 w-5 text-gray-500 dark:text-gray-400 mr-2"}),r.jsxs("span",{className:"text-gray-900 dark:text-white",children:["Size: ",y.unit_size.label]})]})]})]}),r.jsxs("div",{children:[r.jsx("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-2",children:"Schedule"}),r.jsxs("div",{className:"flex items-center",children:[r.jsx(P,{className:"h-5 w-5 text-gray-500 dark:text-gray-400 mr-2"}),r.jsx("span",{className:"text-gray-900 dark:text-white",children:n(y.scheduled_date)})]})]}),r.jsxs("div",{children:[r.jsx("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-2",children:"Assigned To"}),r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"flex items-center",children:[r.jsx(E,{className:"h-5 w-5 text-gray-500 dark:text-gray-400 mr-2"}),r.jsx("span",{className:"text-gray-900 dark:text-white",children:y.assigned_to?pe.find((e=>e.id===y.assigned_to))?.full_name||"Unknown":"Not assigned"})]}),tr&&r.jsx(o,{to:`/dashboard/sub-scheduler?jobId=${u}`,className:"text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300",children:y.assigned_to?"Change":"Assign"})]})]})]}),r.jsx("div",{className:"mt-6 relative z-0",children:r.jsx(g,{address:`${y.property.address}${y.property.address_2?`, ${y.property.address_2}`:""}, ${y.property.city}, ${y.property.state} ${y.property.zip}`,className:"w-full h-[300px]",onMapClick:()=>{const e=document.querySelector(".leaflet-container");e&&e.classList.add("map-active")},onMapLoad:e=>{e.scrollWheelZoom.disable(),e.on("click",(()=>{e.scrollWheelZoom.enable()})),e.on("mouseout",(()=>{e.scrollWheelZoom.disable()}))}})}),y.description&&r.jsxs("div",{className:"mt-6",children:[r.jsx("h3",{className:"text-sm font-medium text-gray-500 dark:text-gray-400 mb-2",children:"Description"}),r.jsx("p",{className:"text-gray-900 dark:text-white whitespace-pre-wrap",children:y.description})]}),r.jsxs("div",{className:"mt-6 flex flex-wrap gap-4",children:[(X||ee)&&!ar&&r.jsxs(o,{to:`/dashboard/jobs/${u}/new-work-order`,className:"inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors",children:[r.jsx(N,{className:"h-4 w-4 mr-2"}),"Add Work Order"]}),!X&&!ee&&sr&&!ar&&r.jsxs(o,{to:`/dashboard/jobs/${u}/new-work-order`,className:"inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors",children:[r.jsx(N,{className:"h-4 w-4 mr-2"}),"Work Order"]})]})]}),r.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 shadow-lg",children:[r.jsxs("div",{className:"flex justify-between items-center mb-4",children:[r.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Phase History"}),r.jsx("button",{onClick:()=>be(!ge),className:"text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300",children:ge?"Show Less":"Show All"})]}),G?r.jsx("div",{className:"flex items-center justify-center py-8",children:r.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"})}):V?r.jsx("div",{className:"text-red-500 dark:text-red-400 text-sm",children:V}):0===L.length?r.jsx("div",{className:"text-gray-500 dark:text-gray-400 text-center py-4",children:"No phase changes recorded"}):r.jsxs("div",{className:"space-y-4",children:[(ge?L:L.slice(0,3)).map(((e,t)=>r.jsxs("div",{className:"relative pb-4",children:[t<L.length-1&&r.jsx("div",{className:"absolute left-4 top-4 h-full w-0.5 bg-gray-200 dark:bg-gray-700",style:{marginLeft:"0.5px"}}),r.jsxs("div",{className:"flex items-start",children:[r.jsx("div",{className:"rounded-full h-9 w-9 flex items-center justify-center flex-shrink-0 z-10",style:{backgroundColor:e.to_phase_color||"#4B5563"},children:r.jsx(A,{className:"h-5 w-5 text-white"})}),r.jsxs("div",{className:"ml-4 flex-1",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("h3",{className:"text-sm font-medium text-gray-900 dark:text-white",children:e.to_phase_label}),r.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:n(e.changed_at)})]}),e.from_phase_label&&r.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:["From: ",e.from_phase_label]}),e.change_reason&&r.jsx("p",{className:"text-sm text-gray-700 dark:text-gray-300 mt-1",children:e.change_reason}),r.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:["By: ",e.changed_by_name||"Unknown"]})]})]})]},e.id))),!ge&&L.length>3&&r.jsx("button",{onClick:()=>be(!0),className:"text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 w-full text-center mt-2",children:"Show More History"})]})]})]}),y.work_order&&r.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 shadow-lg mb-6",children:[dr&&y.work_order.has_extra_charges&&r.jsx("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700/30 text-yellow-800 dark:text-yellow-200 px-4 py-3 rounded-lg mb-6 relative z-[50]",children:r.jsxs("div",{className:"flex items-start",children:[r.jsx(F,{className:"h-5 w-5 mr-2 text-yellow-600 dark:text-yellow-400 mt-0.5"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"font-medium",children:"Extra Charges Pending Approval"}),r.jsx("p",{className:"mt-1 text-sm",children:"This work order has extra charges that require approval before proceeding."}),r.jsx("div",{className:"mt-3 flex space-x-3",children:Re?r.jsxs("button",{onClick:async()=>{if(y)try{const{data:r,error:t}=await e.from("job_phases").select("id").eq("job_phase_label","Work Order").single();if(t)throw t;if(!r)throw new Error("Work Order phase not found");const{error:a}=await e.from("jobs").update({current_phase_id:r.id}).eq("id",y.id);if(a)throw a;await M(),He(!1),alert("Extra charges approved successfully!")}catch(r){alert("Failed to approve extra charges. Please try again.")}},className:"inline-flex items-center px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors",children:[r.jsx(W,{className:"h-4 w-4 mr-2"}),"Approve Extra Charges"]}):r.jsxs("button",{onClick:()=>Ce(!0),className:"inline-flex items-center px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors",children:[r.jsx(_,{className:"h-4 w-4 mr-2"}),"Send Approval Email"]})})]})]})}),ar&&y.work_order?.has_sprinklers&&r.jsx("div",{className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700/30 text-blue-800 dark:text-blue-200 px-4 py-3 rounded-lg mb-6",children:r.jsxs("div",{className:"flex items-start",children:[r.jsx(_,{className:"h-5 w-5 mr-2 text-blue-600 dark:text-blue-400 mt-0.5"}),r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"font-medium",children:"Notification Actions"}),r.jsx("p",{className:"mt-1 text-sm",children:"Send notification emails to property managers about work progress."}),r.jsx("div",{className:"mt-3 flex space-x-3",children:r.jsxs("button",{onClick:()=>{Ze("sprinkler_paint"),Ge(!0)},className:"inline-flex items-center px-3 py-1.5 bg-orange-600 hover:bg-orange-700 text-white text-sm font-medium rounded-lg transition-colors",children:[r.jsx(_,{className:"h-4 w-4 mr-2"}),"Send Sprinkler Paint Notification"]})})]})]})}),r.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-8",children:"Work Order Details"}),r.jsxs("div",{className:"mb-8",children:[r.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center",children:[r.jsx(z,{className:"h-5 w-5 mr-2 text-blue-500"}),"Work Order Details"]}),y.work_order&&r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 dark:bg-[#0F172A] p-4 rounded-lg",children:[r.jsxs("div",{className:`p-3 rounded-lg border ${y.work_order.submission_date?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Submission Date"}),r.jsx("p",{className:`text-lg font-bold ${y.work_order.submission_date?"text-green-800 dark:text-green-200":""} mt-1`,children:n(y.work_order.submission_date)})]}),r.jsxs("div",{className:`p-3 rounded-lg border ${y.work_order.is_occupied?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Occupied Unit"}),r.jsx("p",{className:`text-lg font-bold ${y.work_order.is_occupied?"text-green-800 dark:text-green-200":""} mt-1`,children:y.work_order.is_occupied?"Yes":"No"})]}),r.jsxs("div",{className:`p-3 rounded-lg border ${y.work_order.is_full_paint?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Full Paint"}),r.jsx("p",{className:`text-lg font-bold ${y.work_order.is_full_paint?"text-green-800 dark:text-green-200":""} mt-1`,children:y.work_order.is_full_paint?"Yes":"No"})]}),r.jsxs("div",{className:`p-3 rounded-lg border ${y.work_order.job_category?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Job Category"}),r.jsx("p",{className:`text-lg font-bold ${y.work_order.job_category?"text-green-800 dark:text-green-200":""} mt-1`,children:y.work_order.job_category||"N/A"})]})]})]}),r.jsxs("div",{className:"mb-8",children:[r.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center",children:[r.jsx(D,{className:"h-5 w-5 mr-2 text-blue-500"}),"Paint Information"]}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 dark:bg-[#0F172A] p-4 rounded-lg",children:[r.jsxs("div",{className:`p-3 rounded-lg border ${void 0!==y.work_order.is_full_paint&&y.work_order.is_full_paint?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Full Paint"}),r.jsx("p",{className:`text-lg font-bold ${y.work_order.is_full_paint?"text-green-800 dark:text-green-200":""} mt-1`,children:y.work_order.is_full_paint?"Yes":"No"})]}),r.jsxs("div",{className:`p-3 rounded-lg border ${y.work_order.job_category?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Job Category"}),r.jsx("p",{className:`text-lg font-bold ${y.work_order.job_category?"text-green-800 dark:text-green-200":""} mt-1`,children:y.work_order.job_category||"N/A"})]})]})]}),ar&&y.work_order?.has_sprinklers&&r.jsxs("div",{className:"mb-8",children:[r.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center",children:[r.jsx(O,{className:"h-5 w-5 mr-2 text-blue-500"}),"Sprinkler Information"]}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 dark:bg-[#0F172A] p-4 rounded-lg",children:[r.jsxs("div",{className:`p-3 rounded-lg border ${y.work_order.has_sprinklers?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Has Sprinklers"}),r.jsx("p",{className:`text-lg font-bold ${y.work_order.has_sprinklers?"text-green-800 dark:text-green-200":""} mt-1`,children:y.work_order.has_sprinklers?"Yes":"No"})]}),y.work_order.has_sprinklers&&r.jsxs("div",{className:`p-3 rounded-lg border ${y.work_order.sprinklers_painted?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Sprinklers Painted"}),r.jsx("p",{className:`text-lg font-bold ${y.work_order.sprinklers_painted?"text-green-800 dark:text-green-200":""} mt-1`,children:y.work_order.sprinklers_painted?"Yes":"No"})]})]}),ar&&y.work_order?.has_sprinklers&&y.work_order?.id&&r.jsxs("div",{className:"mt-4",children:[r.jsx("h4",{className:"text-base font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Sprinkler Images"}),Ue&&r.jsx(b,{workOrderId:Ue,folder:"sprinkler"})]})]}),ar&&r.jsxs("div",{className:"mb-8",children:[r.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center",children:[r.jsx(I,{className:"h-5 w-5 mr-2 text-blue-500"}),"Painted Areas"]}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 dark:bg-[#0F172A] p-4 rounded-lg",children:[r.jsxs("div",{className:`p-3 rounded-lg border ${y.work_order.painted_ceilings?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Ceilings"}),r.jsx("p",{className:`text-lg font-bold ${y.work_order.painted_ceilings?"text-green-800 dark:text-green-200":""} mt-1`,children:y.work_order.painted_ceilings?r.jsx(r.Fragment,{children:r.jsxs("span",{className:"text-sm text-gray-500 dark:text-gray-400 ml-2",children:["(",y.work_order.ceiling_rooms_count," rooms)"]})}):"No"})]}),r.jsxs("div",{className:`p-3 rounded-lg border ${y.work_order.painted_patio?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Patio"}),r.jsx("p",{className:`text-lg font-bold ${y.work_order.painted_patio?"text-green-800 dark:text-green-200":""} mt-1`,children:y.work_order.painted_patio?"Yes":"No"})]}),r.jsxs("div",{className:`p-3 rounded-lg border ${y.work_order.painted_garage?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Garage"}),r.jsx("p",{className:`text-lg font-bold ${y.work_order.painted_garage?"text-green-800 dark:text-green-200":""} mt-1`,children:y.work_order.painted_garage?"Yes":"No"})]}),r.jsxs("div",{className:`p-3 rounded-lg border ${y.work_order.painted_cabinets?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Cabinets"}),r.jsx("p",{className:`text-lg font-bold ${y.work_order.painted_cabinets?"text-green-800 dark:text-green-200":""} mt-1`,children:y.work_order.painted_cabinets?"Yes":"No"})]}),r.jsxs("div",{className:`p-3 rounded-lg border ${y.work_order.painted_crown_molding?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Crown Molding"}),r.jsx("p",{className:`text-lg font-bold ${y.work_order.painted_crown_molding?"text-green-800 dark:text-green-200":""} mt-1`,children:y.work_order.painted_crown_molding?"Yes":"No"})]}),r.jsxs("div",{className:`p-3 rounded-lg border ${y.work_order.painted_front_door?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Front Door"}),r.jsx("p",{className:`text-lg font-bold ${y.work_order.painted_front_door?"text-green-800 dark:text-green-200":""} mt-1`,children:y.work_order.painted_front_door?"Yes":"No"})]})]})]}),ar&&y.work_order?.has_accent_wall&&r.jsxs("div",{className:"mb-8",children:[r.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center",children:[r.jsx(T,{className:"h-5 w-5 mr-2 text-blue-500"}),"Accent Wall Details"]}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 bg-gray-50 dark:bg-[#0F172A] p-4 rounded-lg",children:[r.jsxs("div",{className:`p-3 rounded-lg border ${y.work_order.accent_wall_type?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Type"}),r.jsx("p",{className:`text-lg font-bold ${y.work_order.accent_wall_type?"text-green-800 dark:text-green-200":""} mt-1`,children:y.work_order.accent_wall_type||"N/A"})]}),r.jsxs("div",{className:`p-3 rounded-lg border ${y.work_order.accent_wall_count>0?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Count"}),r.jsx("p",{className:`text-lg font-bold ${y.work_order.accent_wall_count>0?"text-green-800 dark:text-green-200":""} mt-1`,children:y.work_order.accent_wall_count||"N/A"})]})]})]}),ar&&y.work_order?.has_extra_charges&&r.jsxs("div",{className:"mb-8",children:[r.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center",children:[r.jsx(F,{className:"h-5 w-5 mr-2 text-blue-500"}),"Extra Charges"]}),r.jsxs("div",{className:"bg-gray-50 dark:bg-[#0F172A] p-4 rounded-lg",children:[r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[r.jsxs("div",{className:`p-3 rounded-lg border ${y.work_order.has_extra_charges?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Has Extra Charges"}),r.jsx("p",{className:"text-sm font-bold "+(y.work_order.has_extra_charges?"text-green-800 dark:text-green-200":""),children:y.work_order.has_extra_charges?"Yes":"No"})]}),r.jsxs("div",{className:`p-3 rounded-lg border ${"number"==typeof y.work_order.extra_hours&&y.work_order.extra_hours>0?"border-green-500/50 bg-green-50 dark:bg-green-900/30":"border-gray-200 dark:border-gray-700"} flex flex-col justify-center`,children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Extra Hours"}),r.jsx("p",{className:`text-lg font-bold ${"number"==typeof y.work_order.extra_hours&&y.work_order.extra_hours>0?"text-green-800 dark:text-green-200":""} mt-1`,children:"number"==typeof y.work_order.extra_hours?y.work_order.extra_hours:"N/A"})]})]}),y.work_order.extra_charges_description&&r.jsxs("div",{className:"p-3 rounded-lg border border-green-500/50 bg-green-50 dark:bg-green-900/30 mt-6",children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Description"}),r.jsx("p",{className:"text-lg font-bold text-green-800 dark:text-green-200 mt-1",children:y.work_order.extra_charges_description})]})]})]}),ar&&y.work_order?.additional_comments&&r.jsxs("div",{className:"mb-8",children:[r.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center",children:[r.jsx(q,{className:"h-5 w-5 mr-2 text-blue-500"}),"Additional Comments"]}),r.jsx("div",{className:"bg-gray-50 dark:bg-[#0F172A] p-4 rounded-lg",children:r.jsx("p",{className:"text-gray-900 dark:text-white whitespace-pre-wrap",children:y.work_order.additional_comments})})]}),ar&&y.work_order?.id&&r.jsxs("div",{className:"mb-8",children:[r.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center",children:[r.jsx(Y,{className:"h-5 w-5 mr-2 text-blue-500"}),"Work Order Images"]}),r.jsxs("div",{className:"space-y-6",children:[r.jsxs("div",{children:[r.jsx("h4",{className:"text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Before Images"}),Ue&&r.jsx(b,{workOrderId:Ue,folder:"before"})]}),r.jsxs("div",{children:[r.jsx("h4",{className:"text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Other Files"}),Ue&&r.jsx(b,{workOrderId:Ue,folder:"other"})]})]})]})]}),(X||ee)&&y.billing_details&&!sr&&r.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 shadow-lg mb-6",children:[r.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-8",children:"Billing Breakdown"}),r.jsxs("div",{className:"mb-6 text-gray-700 dark:text-gray-300",children:[r.jsxs("p",{className:"text-lg",children:["Unit Size: ",r.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:y.unit_size.label})]}),r.jsxs("p",{className:"text-lg mt-1",children:["Job Category: ",r.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:y.work_order?.job_category||"N/A"})]})]}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 bg-gray-50 dark:bg-[#0F172A] p-4 rounded-lg",children:[r.jsxs("div",{className:"p-3 rounded-lg border border-green-500/50",children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Bill Amount"}),r.jsx("p",{className:"text-lg font-semibold text-green-600 dark:text-green-400 mt-1",children:null!==y.billing_details?.bill_amount?l(y.billing_details.bill_amount):"N/A"})]}),r.jsxs("div",{className:"p-3 rounded-lg border border-blue-500/50",children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Subcontractor Pay"}),r.jsx("p",{className:"text-lg font-semibold text-blue-600 dark:text-blue-400 mt-1",children:null!==y.billing_details?.sub_pay_amount?l(y.billing_details.sub_pay_amount):"N/A"})]}),r.jsxs("div",{className:"p-3 rounded-lg border border-purple-500/50",children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Profit"}),r.jsx("p",{className:`text-lg font-semibold ${null!==nr?nr>=0?"text-purple-600 dark:text-purple-400":"text-red-600 dark:text-red-400":"text-gray-900 dark:text-white"} mt-1`,children:null!==nr?l(nr):"N/A"})]})]}),ar&&y.work_order?.has_extra_charges&&y.work_order.extra_hours>0&&r.jsxs("div",{className:"mt-8",children:[r.jsx("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white mb-4",children:"Extra Charges Breakdown"}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 bg-gray-50 dark:bg-[#0F172A] p-4 rounded-lg",children:[r.jsxs("div",{className:"p-3 rounded-lg border border-green-500/50",children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Bill Amount"}),r.jsx("p",{className:"text-lg font-semibold text-green-600 dark:text-green-400 mt-1",children:l(lr)})]}),r.jsxs("div",{className:"p-3 rounded-lg border border-blue-500/50",children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Sub Pay Amount"}),r.jsx("p",{className:"text-lg font-semibold text-blue-600 dark:text-blue-400 mt-1",children:l(ir)})]}),r.jsxs("div",{className:"p-3 rounded-lg border border-purple-500/50",children:[r.jsx("span",{className:"text-sm font-medium text-gray-600 dark:text-gray-400",children:"Profit"}),r.jsx("p",{className:`text-lg font-semibold ${cr>=0?"text-purple-600 dark:text-purple-400":"text-red-600 dark:text-red-400"} mt-1`,children:l(cr)})]})]})]}),r.jsxs("div",{className:"mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center",children:[r.jsx("h3",{className:"text-xl font-semibold text-gray-900 dark:text-white",children:"Total to Invoice"}),r.jsx("span",{className:"text-xl font-bold text-green-600 dark:text-green-400",children:l((y.billing_details?.bill_amount??0)+lr)})]}),y.billing_details&&r.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 space-y-3",children:[r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsx("span",{className:"text-base font-medium text-gray-700 dark:text-gray-300",children:"Total Billing"}),r.jsx("span",{className:"text-base font-semibold text-gray-900 dark:text-white",children:l((y.billing_details?.bill_amount??0)+lr)})]}),r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsx("span",{className:"text-base font-medium text-gray-700 dark:text-gray-300",children:"Total Subcontractor Pay"}),r.jsx("span",{className:"text-base font-semibold text-gray-900 dark:text-white",children:l((y.billing_details?.sub_pay_amount??0)+ir)})]}),r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsx("span",{className:"text-base font-medium text-gray-700 dark:text-gray-300",children:"Total Profit"}),r.jsx("span",{className:"text-base font-semibold "+(null!==nr?nr>=0?"text-purple-600 dark:text-purple-400":"text-red-600 dark:text-red-400":"text-gray-900 dark:text-white"),children:l((y.billing_details?.bill_amount??0)-(y.billing_details?.sub_pay_amount??0)+cr)})]})]})]}),ae&&r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:r.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 max-w-md w-full shadow-xl",children:[r.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Delete Job"}),r.jsx("p",{className:"text-gray-700 dark:text-gray-300 mb-6",children:"Are you sure you want to delete this job? This action cannot be undone."}),r.jsxs("div",{className:"flex justify-end space-x-3",children:[r.jsx("button",{type:"button",onClick:()=>se(!1),className:"px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600",children:"Cancel"}),r.jsx("button",{type:"button",onClick:async()=>{if(u){me(!0);try{const{error:r}=await e.from("job_phase_changes").delete().eq("job_id",u);if(r)throw r;const{error:a}=await e.from("work_orders").delete().eq("job_id",u);if(a)throw a;const{error:s}=await e.from("jobs").delete().eq("id",u);if(s)throw s;t.success("Job deleted successfully"),p("/dashboard/jobs")}catch(r){t.error(r instanceof Error?r.message:"Failed to delete job"),me(!1)}}},disabled:xe,className:"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center",children:xe?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"}),"Deleting..."]}):"Delete Job"})]})]})}),ke&&r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:r.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 max-w-md w-full shadow-xl",children:[r.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Assign Subcontractor"}),r.jsx("div",{className:"space-y-4",children:r.jsxs("div",{children:[r.jsx("label",{htmlFor:"subcontractor",className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Select Subcontractor"}),r.jsxs("select",{id:"subcontractor",value:_e||"",onChange:e=>fe(e.target.value),className:"w-full px-3 py-2 bg-gray-50 dark:bg-[#0F172A] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",children:[r.jsx("option",{value:"",children:"Select subcontractor"}),pe.map((e=>r.jsx("option",{value:e.id,children:e.full_name},e.id)))]})]})}),r.jsxs("div",{className:"mt-6 flex justify-end space-x-3",children:[r.jsx("button",{type:"button",onClick:()=>je(!1),className:"px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600",children:"Cancel"}),r.jsx("button",{type:"button",onClick:async()=>{if(_e){Ne(!0);try{const{error:r}=await e.from("jobs").update({assigned_to:_e}).eq("id",u);if(r)throw r;await M(),je(!1),t.success("Subcontractor assigned successfully")}catch(r){t.error(r instanceof Error?r.message:"Failed to assign subcontractor")}finally{Ne(!1)}}},disabled:!_e||we,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center",children:we?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"}),"Assigning..."]}):"Assign Subcontractor"})]})]})}),ve&&r.jsx(R,{recipientEmail:Pe,ccEmails:Ae,bccEmails:We,emailContent:Se,sendingEmail:qe,job:y,onClose:()=>Ce(!1),onSendEmail:async()=>{if(Pe){Ye(!0);try{alert("Email sent successfully!"),Ce(!1),He(!0)}catch(e){alert("Failed to send email. Please try again.")}finally{Ye(!1)}}else alert("Please enter a recipient email address")},onRecipientChange:Ee,onCCChange:Fe,onBCCChange:ze,onContentChange:$e}),Ie&&r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[150]",children:r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[r.jsxs("div",{className:"flex justify-between items-center mb-4",children:[r.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:"PDF Preview"}),r.jsx("button",{onClick:()=>{Te(!1),Je(void 0)},className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:r.jsx(h,{className:"h-5 w-5"})})]}),r.jsx("div",{className:"border-t border-gray-200 dark:border-gray-700 pt-4",children:Be?r.jsx("iframe",{src:Be,className:"w-full h-[70vh]",title:"PDF Preview"}):r.jsx("div",{className:"flex items-center justify-center h-[70vh]",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})})}),r.jsx("div",{className:"flex justify-end mt-4",children:r.jsx("button",{onClick:()=>{Te(!1),Je(void 0)},className:"px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600",children:"Close"})})]})}),ar&&r.jsx("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 shadow-lg mb-6",children:r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsx("div",{children:ar&&r.jsxs(o,{to:`/dashboard/jobs/${u}/new-work-order?edit=true`,className:"inline-flex items-center px-4 py-2 text-white text-sm font-medium rounded-lg transition-colors",style:{backgroundColor:y.job_phase.color_dark_mode},children:[r.jsx(N,{className:"h-4 w-4 mr-2"}),X||ee?"Edit Work Order":"View Work Order"]})}),r.jsxs("div",{className:"flex space-x-3",children:[r.jsxs("button",{onClick:async()=>{if(!y)return;const r=new m;let t=20;const a=20;if(r.setFontSize(20),r.text(`Work Order: ${Qe(y.work_order_num)}`,a,t),t+=15,r.setFontSize(12),r.text(`Property: ${y.property.name}`,a,t),t+=10,r.text(`Unit: ${y.unit_number}`,a,t),t+=10,r.text(`Unit Size: ${y.unit_size.label}`,a,t),t+=10,r.text(`Job Type: ${y.job_type.label}`,a,t),t+=10,r.text(`Scheduled Date: ${n(y.scheduled_date)}`,a,t),t+=10,r.text(`Status: ${y.job_phase.label}`,a,t),t+=15,y.description){r.setFontSize(14),r.text("Description:",a,t),t+=10,r.setFontSize(12);const e=r.splitTextToSize(y.description,170);r.text(e,a,t),t+=7*e.length}if(y.work_order){if(t>180&&(r.addPage(),t=20),r.setFontSize(16),r.text("Work Order Details",a,t),t+=15,r.setFontSize(12),r.text(`Submission Date: ${n(y.work_order.submission_date)}`,a,t),t+=10,r.text("Occupied: "+(y.work_order.is_occupied?"Yes":"No"),a,t),t+=10,r.text("Full Paint: "+(y.work_order.is_full_paint?"Yes":"No"),a,t),t+=10,r.text(`Job Category: ${y.work_order.job_category}`,a,t),t+=15,y.work_order.has_sprinklers&&(r.text("Has Sprinklers: Yes",a,t),t+=10,r.text("Sprinklers Painted: "+(y.work_order.sprinklers_painted?"Yes":"No"),a,t),t+=10),y.work_order.painted_ceilings&&(r.text("Painted Ceilings: Yes",a,t),t+=10,r.text(`Ceiling Rooms: ${y.work_order.ceiling_rooms_count}`,a,t),t+=10),y.work_order.painted_patio&&(r.text("Painted Patio: Yes",a,t),t+=10),y.work_order.painted_garage&&(r.text("Painted Garage: Yes",a,t),t+=10),y.work_order.painted_cabinets&&(r.text("Painted Cabinets: Yes",a,t),t+=10),y.work_order.painted_crown_molding&&(r.text("Painted Crown Molding: Yes",a,t),t+=10),y.work_order.painted_front_door&&(r.text("Painted Front Door: Yes",a,t),t+=10),y.work_order.has_extra_charges){if(t>180&&(r.addPage(),t=20),t+=5,r.text("Has Extra Charges: Yes",a,t),t+=10,y.work_order.extra_charges_description){const e=r.splitTextToSize(y.work_order.extra_charges_description,170);r.text(e,a,t),t+=7*e.length}r.text(`Extra Hours: ${y.work_order.extra_hours||"N/A"}`,a,t),t+=10}if(y.work_order.additional_comments){t>180&&(r.addPage(),t=20),t+=5,r.text("Additional Comments:",a,t),t+=10;const e=r.splitTextToSize(y.work_order.additional_comments,170);r.text(e,a,t),t+=7*e.length}}if(y.billing_details&&(t>180&&(r.addPage(),t=20),r.setFontSize(16),r.text("Billing Details",a,t),t+=15,r.setFontSize(12),r.text(`Bill Amount: ${l(y.billing_details.bill_amount)}`,a,t),t+=10,r.text(`Subcontractor Pay: ${l(y.billing_details.sub_pay_amount)}`,a,t),t+=10,null!==y.billing_details.profit_amount&&(r.text(`Profit: ${l(y.billing_details.profit_amount)}`,a,t),t+=10),y.extra_charges_details&&(t+=5,r.text("Extra Charges Billing:",a,t),t+=10,r.text(`Hours: ${y.extra_charges_details.hours||0}`,a,t),t+=10,r.text(`Bill Amount: ${l(y.extra_charges_details.bill_amount)}`,a,t),t+=10,r.text(`Subcontractor Pay: ${l(y.extra_charges_details.sub_pay_amount)}`,a,t),t+=10,null!==y.extra_charges_details.profit_amount&&(r.text(`Profit: ${l(y.extra_charges_details.profit_amount)}`,a,t),t+=10))),y.work_order?.id)try{const{data:d,error:o}=await e.storage.from("work_orders").list(`${y.work_order.id}`);if(!o&&d&&d.length>0){t>130&&(r.addPage(),t=20),r.setFontSize(16),r.text("Job Images",a,t),t+=15;for(const o of d){const{data:d}=await e.storage.from("work_orders").getPublicUrl(`${y.work_order.id}/${o.name}`);if(d)try{const e=new Y;e.src=d.publicUrl,await new Promise((r=>{e.onload=r}));const s=170,o=100;let n=e.width,l=e.height;n>s&&(l=s*l/n,n=s),l>o&&(n=o*n/l,l=o),t+l>260&&(r.addPage(),t=20),r.addImage(e,"JPEG",a,t,n,l),t+=l+10}catch(s){}}}}catch(s){}r.save(`work-order-${y.work_order_num}.pdf`)},className:"inline-flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-sm font-medium rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors",children:[r.jsx(B,{className:"h-4 w-4 mr-2"}),"Download PDF"]}),r.jsxs("button",{onClick:()=>window.print(),className:"inline-flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-sm font-medium rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors",children:[r.jsx(J,{className:"h-4 w-4 mr-2"}),"Print"]})]})]})}),or&&r.jsx("div",{className:"flex justify-end mb-6",children:r.jsxs("button",{onClick:async()=>{try{if(!y)return;const e=new m;let r=20;const t=20,a=new window.Image;a.src="https://tbwtfimnbmvbgesidbxh.supabase.co/storage/v1/object/public/files/fb38963b-c67e-4924-860b-312045d19d2f/1750132407578_jg-logo-icon.png";let s=!1;await new Promise((e=>{a.onload=()=>{s=!0,e()},setTimeout((()=>{s||e()}),2e3)})),s&&(e.addImage(a,"PNG",t,r,17,17),r+=35),e.setFontSize(22),e.text("INVOICE",t,r),r+=15,e.setFontSize(10),e.text(`Date: ${n((new Date).toISOString())}`,t,r),r+=6,e.text(`Invoice #: ${Qe(y.work_order_num)}`,t,r),r+=6,e.text(`Property: ${y.property.name}`,t,r),r+=6,e.text(`Unit: ${y.unit_number}`,t,r),r+=6,e.text(`Address: ${i(y.property)}`,t,r),r+=6,e.text(`Job Type: ${y.job_type.label}`,t,r),r+=10,e.setFontSize(12),e.text("Billing Breakdown",t,r),r+=6,e.setFontSize(9);let d=r;e.text("Description",t,d),e.text("Amount",t+120,d),d+=6,e.setLineWidth(.1),e.line(t,d,t+170,d),d+=4;const o=`${y.work_order?.job_category||"Standard Paint"} - ${y.unit_size.label}`;if(e.text(o,t,d),e.text(`${l(y.billing_details?.bill_amount??0)}`,t+120,d),d+=6,y.work_order?.has_extra_charges&&y.work_order.extra_hours&&y.work_order.extra_hours>0){const r=y.work_order.extra_charges_description||"Extra Charges",a=y.work_order.extra_hours,s=40,o=`Extra Charges: ${r}`,n=e.splitTextToSize(o,110);e.text(n,t,d),e.text(`${l(a*s)}`,t+120,d),d+=6*n.length}d+=4,e.setFontSize(10),e.text("Total",t,d);let c=y.billing_details?.bill_amount??0;y.work_order?.has_extra_charges&&y.work_order.extra_hours&&y.work_order.extra_hours>0&&(c+=40*y.work_order.extra_hours),e.text(`${l(c)}`,t+120,d),d+=15,e.setFontSize(9),e.text("Thank you for your business!",t,d),e.addPage();let x=20;if(e.setFontSize(14),e.text("Work Order Information",t,x),x+=8,e.setFontSize(9),e.text(`Work Order #: ${Qe(y.work_order_num)}`,t,x),x+=6,e.text(`Property: ${y.property.name}`,t,x),x+=6,e.text(`Unit: ${y.unit_number}`,t,x),x+=6,e.text(`Unit Size: ${y.unit_size.label}`,t,x),x+=6,e.text(`Job Type: ${y.job_type.label}`,t,x),x+=6,e.text(`Scheduled Date: ${n(y.scheduled_date)}`,t,x),x+=6,e.text(`Status: ${y.job_phase.label}`,t,x),x+=8,y.work_order){if(e.setFontSize(11),e.text("Work Order Details",t,x),x+=6,e.setFontSize(9),e.text(`Submission Date: ${n(y.work_order.submission_date)}`,t,x),x+=6,e.text("Occupied: "+(y.work_order.is_occupied?"Yes":"No"),t,x),x+=6,e.text("Full Paint: "+(y.work_order.is_full_paint?"Yes":"No"),t,x),x+=6,e.text(`Job Category: ${y.work_order.job_category}`,t,x),x+=6,y.work_order.has_sprinklers&&(e.text("Has Sprinklers: Yes",t,x),x+=6,e.text("Sprinklers Painted: "+(y.work_order.sprinklers_painted?"Yes":"No"),t,x),x+=6),y.work_order.painted_ceilings&&(e.text("Painted Ceilings: Yes",t,x),x+=6,e.text(`Ceiling Rooms: ${y.work_order.ceiling_rooms_count}`,t,x),x+=6),y.work_order.painted_patio&&(e.text("Painted Patio: Yes",t,x),x+=6),y.work_order.painted_garage&&(e.text("Painted Garage: Yes",t,x),x+=6),y.work_order.painted_cabinets&&(e.text("Painted Cabinets: Yes",t,x),x+=6),y.work_order.painted_crown_molding&&(e.text("Painted Crown Molding: Yes",t,x),x+=6),y.work_order.painted_front_door&&(e.text("Painted Front Door: Yes",t,x),x+=6),y.work_order.has_accent_wall&&(e.text(`Accent Wall: ${y.work_order.accent_wall_type||""} (${y.work_order.accent_wall_count||1})`,t,x),x+=6),y.work_order.has_extra_charges){if(e.text("Has Extra Charges: Yes",t,x),x+=6,y.work_order.extra_charges_description){const r=e.splitTextToSize(y.work_order.extra_charges_description,170);e.text(r,t,x),x+=6*r.length}e.text(`Extra Hours: ${y.work_order.extra_hours||"N/A"}`,t,x),x+=6}if(y.work_order.additional_comments){e.text("Additional Comments:",t,x),x+=6;const r=e.splitTextToSize(y.work_order.additional_comments,170);e.text(r,t,x),x+=6*r.length}}e.save(`invoice-${y.work_order_num}.pdf`)}catch(e){alert("Failed to generate invoice PDF. Please try again.")}},className:"inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors",children:[r.jsx(J,{className:"h-4 w-4 mr-2"}),"Print Invoice"]})}),Le&&Ve&&r.jsx(H,{isOpen:Le,onClose:()=>{Ge(!1),Ze(null)},job:y,notificationType:Ve,onSent:()=>{t.success("Notification sent successfully"),Ge(!1),Ze(null)}})]})})}export{U as JobDetails};

import{s as e,j as s}from"./index-BXIsiie0.js";import{r as a,L as t}from"./react-vendor--AdGielI.js";import{u as r}from"./useSessionValidation-CKCtQpVn.js";import{a as l,d,e as o,c as n,f as i,g as c,h as x,j as m,i as h,k as b,b as p,p as g}from"./utils-D-HhOMZR.js";import{k as y,aa as u,c as j,n as _,ab as k,p as f,q as N,r as w}from"./ui-a3QeRpHh.js";import"./supabase-Dq0wjmmz.js";function v(){r();const[v,C]=a.useState(new Date),[E,M]=a.useState(new Date),[B,S]=a.useState([]),[A,D]=a.useState(!0),[$,T]=a.useState(null),[F,U]=a.useState(null),[X,Y]=a.useState([]),[J,P]=a.useState([]),[V,q]=a.useState(!1);a.useEffect((()=>{W()}),[]),a.useEffect((()=>{z()}),[v,J]),a.useEffect((()=>{const s=e.channel("calendar_jobs").on("postgres_changes",{event:"*",schema:"public",table:"jobs"},(()=>{z()})).subscribe(),a=e.channel("calendar_work_orders").on("postgres_changes",{event:"*",schema:"public",table:"work_orders"},(()=>{z()})).subscribe();return()=>{e.removeChannel(s),e.removeChannel(a)}}),[v,J]);const W=async()=>{try{const{data:s,error:a}=await e.from("job_phases").select("id, job_phase_label, color_dark_mode").order("sort_order");if(a)throw a;Y(s||[])}catch(s){T(s instanceof Error?s.message:"Failed to fetch job phases")}},z=async()=>{try{let s=[];if(J.length>0){const{data:a,error:t}=await e.from("job_phases").select("id").in("job_phase_label",J);if(t)throw t;s=a.map((e=>e.id))}else{const{data:a,error:t}=await e.from("job_phases").select("id").not("job_phase_label","eq","Cancelled");if(t)throw t;s=a.map((e=>e.id))}const a=l(d(v),"America/New_York","yyyy-MM-dd'T'00:00:00XXX"),t=l(o(v),"America/New_York","yyyy-MM-dd'T'23:59:59XXX"),{data:r,error:n}=await e.from("jobs").select("\n          id,\n          work_order_num,\n          property:properties (\n            property_name\n          ),\n          unit_number,\n          description,\n          scheduled_date,\n          job_phase:current_phase_id (\n            job_phase_label,\n            color_dark_mode\n          ),\n          job_type:job_types (\n            job_type_label\n          ),\n          assigned_to,\n          profiles:assigned_to (\n            full_name\n          )\n        ").in("current_phase_id",s).gte("scheduled_date",a).lte("scheduled_date",t);if(n)throw n;const i=r?.map((e=>({id:e.id,work_order_num:e.work_order_num,unit_number:e.unit_number,description:e.description,scheduled_date:e.scheduled_date,assigned_to:e.assigned_to,property:Array.isArray(e.property)&&e.property.length>0?e.property[0]:e.property||{property_name:"Unknown Property"},job_phase:Array.isArray(e.job_phase)&&e.job_phase.length>0?e.job_phase[0]:e.job_phase||{job_phase_label:"Unknown",color_dark_mode:"#6B7280"},job_type:Array.isArray(e.job_type)&&e.job_type.length>0?e.job_type[0]:e.job_type||{job_type_label:"Unknown"},assigned_to_name:Array.isArray(e.profiles)&&e.profiles.length>0?e.profiles[0]?.full_name||null:e.profiles?.full_name||null})))||[];S(i)}catch(s){T(s instanceof Error?s.message:"Failed to fetch jobs")}finally{D(!1)}},L=e=>`WO-${String(e).padStart(6,"0")}`,O=e=>B.filter((s=>{const a=g(s.scheduled_date);return l(a,"America/New_York","yyyy-MM-dd")===l(e,"America/New_York","yyyy-MM-dd")})),Q=e=>{P((s=>s.includes(e)?s.filter((s=>s!==e)):[...s,e]))};return A?s.jsx("div",{className:"flex items-center justify-center h-full",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):s.jsxs("div",{className:"p-6 bg-gray-100 dark:bg-[#0F172A] min-h-screen",children:[s.jsxs("div",{className:"flex items-center justify-between mb-8",children:[s.jsxs("div",{className:"flex items-center space-x-3",children:[s.jsx(y,{className:"h-8 w-8 text-gray-500 dark:text-gray-400"}),s.jsx("h1",{className:"text-2xl font-semibold text-gray-900 dark:text-white",children:"Calendar"})]}),s.jsxs("div",{className:"flex items-center space-x-4",children:[s.jsx("button",{onClick:()=>C(n(v,1)),className:"p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors",children:s.jsx(u,{className:"h-5 w-5"})}),s.jsx("h2",{className:"text-xl font-medium text-gray-900 dark:text-white",children:i(v,"MMMM yyyy")}),s.jsx("button",{onClick:()=>C(c(v,1)),className:"p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors",children:s.jsx(j,{className:"h-5 w-5"})})]})]}),s.jsxs("div",{className:"mb-6",children:[s.jsxs("div",{className:"flex items-center justify-between mb-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsxs("button",{onClick:()=>q(!V),className:"flex items-center px-3 py-2 bg-white dark:bg-[#1E293B] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-[#2D3B4E] transition-colors",children:[s.jsx(_,{className:"h-4 w-4 mr-2"}),"Filter by Phase"]}),J.length>0&&s.jsx("button",{onClick:()=>{P([])},className:"text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300",children:"Clear Filters"})]}),s.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:J.length>0?`Showing ${J.length} phase${1!==J.length?"s":""}`:"Showing all phases"})]}),V&&s.jsx("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-4 shadow mb-4",children:s.jsx("div",{className:"flex flex-wrap gap-2",children:X.map((e=>s.jsxs("button",{onClick:()=>Q(e.job_phase_label),className:"flex items-center px-3 py-2 rounded-lg text-sm transition-colors "+(J.includes(e.job_phase_label)?"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300":"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400"),children:[s.jsx("span",{className:"w-3 h-3 rounded-full mr-2",style:{backgroundColor:e.color_dark_mode}}),e.job_phase_label,J.includes(e.job_phase_label)?s.jsx(k,{className:"h-4 w-4 ml-2"}):null]},e.id)))})}),J.length>0&&s.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:J.map((e=>{const a=X.find((s=>s.job_phase_label===e));return s.jsxs("div",{className:"flex items-center px-2 py-1 rounded-full text-xs",style:{backgroundColor:`${a?.color_dark_mode}20`,color:a?.color_dark_mode||"#4B5563"},children:[s.jsx("span",{className:"w-2 h-2 rounded-full mr-1",style:{backgroundColor:a?.color_dark_mode}}),e,s.jsx("button",{onClick:()=>Q(e),className:"ml-1 hover:opacity-70",children:s.jsx(f,{className:"h-3 w-3"})})]},e)}))})]}),$&&s.jsx("div",{className:"mb-6 bg-red-50 dark:bg-red-900/50 border border-red-200 dark:border-red-500/50 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg",children:$}),s.jsxs("div",{className:"flex gap-6",children:[s.jsx("div",{className:"flex-1",children:s.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg overflow-hidden shadow",children:[s.jsx("div",{className:"grid grid-cols-7 gap-px bg-gray-200 dark:bg-[#2D3B4E]",children:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map((e=>s.jsx("div",{className:"bg-white dark:bg-[#1E293B] px-4 py-3 text-center",children:s.jsx("span",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:e})},e)))}),s.jsx("div",{className:"grid grid-cols-7 gap-px bg-gray-200 dark:bg-[#2D3B4E]",children:(()=>{const e=d(v),s=[];let a=b(e);for(let t=0;t<42;t++)s.push(a),a=p(a,1);return s})().map(((e,a)=>{const t=O(e),r=x(e,v),l=m(e),d=h(e,E);return s.jsxs("div",{onClick:()=>M(e),className:"cursor-pointer min-h-[120px] p-2 transition-colors "+(r?l?"bg-blue-50 dark:bg-blue-900/20":d?"bg-blue-25 dark:bg-blue-900/10":"bg-white dark:bg-[#1E293B] hover:bg-gray-50 dark:hover:bg-[#2D3B4E]":"opacity-50 bg-white dark:bg-[#1E293B]"),children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("span",{className:"text-sm font-medium "+(l?"text-blue-600 dark:text-blue-400":d?"text-blue-500 dark:text-blue-300":"text-gray-700 dark:text-gray-400"),children:i(e,"d")}),t.length>0&&s.jsxs("span",{className:"text-xs text-gray-500 dark:text-gray-500",children:[t.length," job",1!==t.length?"s":""]})]}),s.jsxs("div",{className:"space-y-1 overflow-y-auto max-h-[80px]",children:[t.slice(0,3).map((e=>s.jsxs("button",{onClick:s=>{s.stopPropagation(),U(e)},className:"w-full text-left p-1 rounded text-xs hover:bg-gray-100 dark:hover:bg-[#2D3B4E] transition-colors",style:{backgroundColor:`${e.job_phase.color_dark_mode}20`},children:[s.jsxs("div",{className:"font-medium text-gray-900 dark:text-white truncate flex items-center",children:[s.jsx("span",{className:"w-2 h-2 rounded-full mr-1 flex-shrink-0",style:{backgroundColor:e.job_phase.color_dark_mode}}),L(e.work_order_num)]}),s.jsx("div",{className:"text-gray-600 dark:text-gray-400 truncate",children:e.property.property_name})]},e.id))),t.length>3&&s.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 text-center",children:["+",t.length-3," more"]})]})]},a)}))})]})}),s.jsx("div",{className:"w-80",children:s.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg shadow h-fit",children:[s.jsxs("div",{className:"p-4 border-b border-gray-200 dark:border-[#2D3B4E]",children:[s.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white flex items-center",children:[s.jsx(y,{className:"h-5 w-5 mr-2 text-blue-500"}),m(E)?"Today's Agenda":i(E,"MMM d, yyyy")]}),s.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:[O(E).length," job",1!==O(E).length?"s":""," scheduled"]})]}),s.jsx("div",{className:"p-4",children:0===O(E).length?s.jsxs("div",{className:"text-center py-8",children:[s.jsx(y,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),s.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"No jobs scheduled for this day"})]}):s.jsx("div",{className:"space-y-3 max-h-[600px] overflow-y-auto",children:O(E).map((e=>s.jsxs("div",{className:"border border-gray-200 dark:border-[#2D3B4E] rounded-lg p-3 hover:shadow-md transition-shadow",style:{backgroundColor:`${e.job_phase.color_dark_mode}0A`},children:[s.jsxs("div",{className:"flex items-start justify-between mb-2",children:[s.jsxs("div",{className:"flex-1",children:[s.jsx("h4",{className:"font-medium text-gray-900 dark:text-white text-sm",children:L(e.work_order_num)}),s.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:e.property.property_name}),s.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-500",children:["Unit #",e.unit_number]})]}),s.jsx("span",{className:"text-xs px-2 py-1 rounded-full",style:{backgroundColor:e.job_phase.color_dark_mode,color:"white"},children:e.job_phase.job_phase_label})]}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("span",{className:"text-xs text-gray-600 dark:text-gray-400",children:e.job_type.job_type_label}),s.jsxs("div",{className:"flex space-x-2",children:[s.jsx("button",{onClick:()=>U(e),className:"text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300",children:"View Details"}),s.jsx(t,{to:`/dashboard/jobs/${e.id}`,className:"text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300",children:"Edit Job"})]})]}),e.assigned_to_name&&s.jsxs("div",{className:"mt-2 flex items-center text-xs text-gray-600 dark:text-gray-400",children:[s.jsx(N,{className:"h-3 w-3 mr-1"}),e.assigned_to_name]})]},e.id)))})})]})})]}),F&&s.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:s.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 max-w-lg w-full shadow-xl",children:[s.jsxs("div",{className:"flex justify-between items-start mb-4",children:[s.jsxs("div",{children:[s.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:L(F.work_order_num)}),s.jsxs("p",{className:"text-gray-600 dark:text-gray-400",children:[F.property.property_name," â€¢ Unit #",F.unit_number]})]}),s.jsx("span",{className:"text-sm px-2 py-1 rounded",style:{backgroundColor:F.job_phase.color_dark_mode,color:"white"},children:F.job_phase.job_phase_label})]}),s.jsxs("div",{className:"space-y-4 mb-6",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-600 dark:text-gray-400",children:"Job Type"}),s.jsx("p",{className:"text-gray-900 dark:text-white",children:F.job_type.job_type_label})]}),F.description&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-600 dark:text-gray-400",children:"Description"}),s.jsx("p",{className:"text-gray-900 dark:text-white",children:F.description})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-600 dark:text-gray-400",children:"Scheduled Date"}),s.jsxs("p",{className:"text-gray-900 dark:text-white flex items-center",children:[s.jsx(w,{className:"h-4 w-4 mr-2 text-gray-400"}),(G=F.scheduled_date,l(g(G),"America/New_York","MMM d, yyyy"))]})]}),F.assigned_to&&s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-600 dark:text-gray-400",children:"Assigned To"}),s.jsxs("p",{className:"text-gray-900 dark:text-white flex items-center",children:[s.jsx(N,{className:"h-4 w-4 mr-2 text-blue-500"}),F.assigned_to_name||"Unknown Subcontractor"]})]})]}),s.jsxs("div",{className:"flex justify-end space-x-3",children:[s.jsx("button",{onClick:()=>U(null),className:"px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors",children:"Close"}),s.jsx(t,{to:`/dashboard/jobs/${F.id}`,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700 transition-colors",children:"View Job Details"})]})]})})]});var G}export{v as Calendar};

import{s as e,j as r}from"./index-BXIsiie0.js";import{k as t,r as s}from"./react-vendor--AdGielI.js";import"./supabase-Dq0wjmmz.js";const a=()=>{const{token:a}=t(),[n,o]=s.useState(null),[i,l]=s.useState(!0),[d,c]=s.useState(!1),[p,x]=s.useState(null),[m,h]=s.useState(!1);s.useEffect((()=>{a?b():(x("Invalid approval link - no token provided"),l(!1))}),[a]);const b=async()=>{try{const t=new Promise(((e,r)=>setTimeout((()=>r(new Error("Query timeout after 10 seconds"))),1e4))),s=e.from("approval_tokens").select("*").eq("token",a).is("used_at",null).gt("expires_at",(new Date).toISOString()).single(),{data:n,error:i}=await Promise.race([s,t]);if(i){if("PGRST116"===i.code){const{data:r,error:t}=await e.from("approval_tokens").select("used_at, expires_at, created_at").eq("token",a).single();t?x("Invalid approval link - token not found in database"):r.used_at?x(`This approval link has already been used on ${new Date(r.used_at).toLocaleString()}`):new Date(r.expires_at)<new Date?x(`This approval link expired on ${new Date(r.expires_at).toLocaleString()}`):x("Invalid approval link - unknown issue")}else x(`Database error: ${i.message}`);return}if(!n)return void x("Invalid or expired approval link - no data returned");let l=n;try{const{data:r,error:t}=await e.from("approval_tokens").select("\n            *,\n            jobs!inner (\n              id,\n              work_order_num,\n              unit_number,\n              property_id,\n              properties!inner (\n                name,\n                address,\n                address_2,\n                city,\n                state,\n                zip\n              )\n            )\n          ").eq("id",n.id).single();if(t)throw new Error("Join failed");l=r}catch(r){const{data:t,error:s}=await e.from("jobs").select("id, work_order_num, unit_number, property_id").eq("id",n.job_id).single();if(s||!t)throw new Error("Could not fetch job data");const{data:a,error:o}=await e.from("properties").select("name, address, address_2, city, state, zip").eq("id",t.property_id).single();l=o||!a?n.extra_charges_data?.job_details?.property?{...n,job:{...t,property:n.extra_charges_data.job_details.property}}:{...n,job:{...t,property:{name:"Property information not available",address:"Address not available",city:"Unknown City",state:"Unknown State",zip:"Unknown Zip"}}}:{...n,job:{...t,property:a}}}o(l)}catch(t){t instanceof Error&&"Query timeout after 10 seconds"===t.message?x("Request timed out. Please check your internet connection and try again."):x(`Failed to load approval data: ${t instanceof Error?t.message:"Unknown error"}`)}finally{l(!1)}};if(i)return r.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600",children:"Loading approval request..."})]})});if(p)return r.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:r.jsxs("div",{className:"max-w-md mx-auto text-center bg-white rounded-lg shadow-lg p-8",children:[r.jsx("div",{className:"text-6xl mb-4",children:"âŒ"}),r.jsx("h1",{className:"text-2xl font-bold text-red-600 mb-4",children:"Error"}),r.jsx("p",{className:"text-gray-600 mb-6",children:p}),r.jsx("p",{className:"text-sm text-gray-500",children:"If you believe this is an error, please contact JG Painting Pros Inc."})]})});if(d)return r.jsx("div",{className:"min-h-screen flex items-center justify-center bg-green-50",children:r.jsxs("div",{className:"max-w-lg mx-auto text-center bg-white rounded-lg shadow-lg p-8",children:[r.jsx("div",{className:"text-6xl mb-6",children:"âœ…"}),r.jsx("h1",{className:"text-3xl font-bold text-green-600 mb-4",children:"Extra Charges Approved!"}),r.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-6",children:[r.jsxs("p",{className:"text-green-800 font-medium",children:["Job #",n?.job.work_order_num.toString().padStart(6,"0")]}),r.jsx("p",{className:"text-green-700",children:n?.job.property.name}),r.jsxs("p",{className:"text-green-700 text-sm",children:["Unit: ",n?.job.unit_number]})]}),r.jsxs("p",{className:"text-gray-600 mb-4",children:["Thank you for approving the extra charges of"," ",r.jsxs("span",{className:"font-bold text-green-600",children:["$",n?.extra_charges_data.total.toFixed(2)]})]}),r.jsx("p",{className:"text-sm text-gray-500 mb-6",children:"We will proceed with the work order phase immediately. You will receive updates as work progresses."}),r.jsxs("div",{className:"text-xs text-gray-400 border-t pt-4",children:["Approved by: ",n?.approver_name||n?.approver_email,r.jsx("br",{}),"Date: ",(new Date).toLocaleString()]})]})});if(!n)return null;const g=`${n.job.property.address}${n.job.property.address_2?`, ${n.job.property.address_2}`:""}, ${n.job.property.city}, ${n.job.property.state} ${n.job.property.zip}`,j=new Date(n.expires_at).getTime()-Date.now()<864e5;return r.jsx("div",{className:"min-h-screen bg-gray-50 py-8",children:r.jsxs("div",{className:"max-w-3xl mx-auto px-4",children:[r.jsxs("div",{className:"text-center mb-8",children:[r.jsx("div",{className:"mb-4",children:r.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4",children:r.jsx("span",{className:"text-2xl",children:"ðŸ“‹"})})}),r.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Approve Extra Charges"}),r.jsxs("p",{className:"text-lg text-gray-600",children:["Job #",n.job.work_order_num.toString().padStart(6,"0")," - ",n.job.property.name]}),j&&r.jsx("div",{className:"mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:r.jsx("p",{className:"text-yellow-800 text-sm",children:"âš ï¸ This approval link expires soon. Please review and approve as soon as possible."})})]}),r.jsxs("div",{className:"bg-white rounded-lg shadow-lg overflow-hidden",children:[r.jsxs("div",{className:"bg-gray-50 px-6 py-4 border-b",children:[r.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Property Details"}),r.jsxs("div",{className:"space-y-1 text-sm text-gray-700",children:[r.jsx("p",{className:"font-medium",children:n.job.property.name}),r.jsx("p",{children:g}),r.jsxs("p",{children:["Unit: ",n.job.unit_number]})]})]}),r.jsxs("div",{className:"px-6 py-6",children:[r.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Extra Charges for Approval"}),r.jsx("div",{className:"space-y-3 mb-6",children:n.extra_charges_data.items.map(((e,t)=>r.jsxs("div",{className:"flex justify-between items-center py-3 border-b border-gray-100 last:border-b-0",children:[r.jsxs("div",{className:"flex-1",children:[r.jsx("p",{className:"font-medium text-gray-900",children:e.description}),e.hours&&r.jsxs("p",{className:"text-sm text-gray-600",children:["Hours: ",e.hours]})]}),r.jsx("div",{className:"text-right",children:r.jsxs("p",{className:"font-semibold text-gray-900",children:["$",e.cost.toFixed(2)]})})]},t)))}),r.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6",children:r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsx("span",{className:"text-lg font-semibold text-blue-900",children:"Total Extra Charges:"}),r.jsxs("span",{className:"text-2xl font-bold text-blue-900",children:["$",n.extra_charges_data.total.toFixed(2)]})]})}),r.jsxs("div",{className:"text-center",children:[r.jsxs("div",{className:"mb-6",children:[r.jsx("p",{className:"text-gray-700 mb-2",children:'By clicking "Approve Extra Charges" below, you authorize JG Painting Pros Inc. to proceed with the additional work and charges listed above.'}),r.jsx("p",{className:"text-sm text-gray-500",children:"This approval will move the job to the Work Order phase and our team will be notified to proceed immediately."})]}),r.jsx("button",{onClick:async()=>{if(n){h(!0);try{const{data:t,error:s}=await e.rpc("process_approval_token",{p_token:a});if(s)throw new Error(`Approval failed: ${s.message}`);if(!t?.success)throw new Error(t?.error||"Approval failed for unknown reason");c(!0);try{window.opener&&!window.opener.closed&&window.opener.postMessage({type:"APPROVAL_COMPLETED",jobId:n.job_id,timestamp:Date.now()},window.location.origin),window.dispatchEvent(new CustomEvent("approvalCompleted",{detail:{jobId:n.job_id}}))}catch(r){}}catch(t){x(`Failed to process approval: ${t instanceof Error?t.message:"Unknown error"}`)}finally{h(!1)}}},disabled:m,className:"inline-flex items-center px-8 py-4 border border-transparent text-lg font-semibold rounded-lg text-white transition-colors "+(m?"bg-gray-400 cursor-not-allowed":"bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-500 focus:ring-opacity-50"),children:m?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"}),"Processing..."]}):r.jsxs(r.Fragment,{children:["âœ… Approve Extra Charges - $",n.extra_charges_data.total.toFixed(2)]})}),r.jsxs("div",{className:"mt-6 text-xs text-gray-400 space-y-1",children:[r.jsxs("p",{children:["Secure approval link â€¢ Expires: ",new Date(n.expires_at).toLocaleString()]}),r.jsx("p",{children:"For questions, contact JG Painting Pros Inc."})]})]})]})]}),r.jsx("div",{className:"text-center mt-8 text-sm text-gray-500",children:r.jsx("p",{children:"JG Painting Pros Inc. - Professional Painting Services"})})]})})};export{a as default};

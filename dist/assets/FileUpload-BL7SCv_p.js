import{s as e,j as r}from"./index-nRXVoRx_.js";import{u as t,r as a}from"./react-vendor--AdGielI.js";import{i as d,p as i}from"./ui-a3QeRpHh.js";import"./supabase-Dq0wjmmz.js";function o(){const o=t(),[l,n]=a.useState(!1),[c,p]=a.useState(null),[m,x]=a.useState([]),[h,y]=a.useState([]),[f,b]=a.useState([]),[u,g]=a.useState([]),[j,_]=a.useState({property_id:"",job_id:"",folder_id:""});a.useEffect((()=>{Promise.all([k(),w(),v()])}),[]),a.useEffect((()=>{j.property_id&&w()}),[j.property_id]);const k=async()=>{try{const{data:r,error:t}=await e.from("properties").select("id, property_name").order("property_name");if(t)throw t;x(r||[])}catch(r){}},w=async()=>{if(j.property_id)try{const{data:r,error:t}=await e.from("jobs").select("\n          id,\n          work_order_num,\n          unit_number,\n          property:properties (\n            property_name\n          )\n        ").eq("property_id",j.property_id).order("created_at",{ascending:!1});if(t)throw t;y(r||[])}catch(r){}else y([])},v=async()=>{try{const{data:r,error:t}=await e.from("files").select("id, name, path").eq("type","folder/directory").order("name");if(t)throw t;b(r||[])}catch(r){}};return r.jsxs("div",{className:"p-6 bg-gray-100 dark:bg-[#0F172A] min-h-screen",children:[r.jsx("div",{className:"flex items-center justify-between mb-8",children:r.jsxs("div",{className:"flex items-center space-x-3",children:[r.jsx(d,{className:"h-8 w-8 text-gray-500 dark:text-gray-400"}),r.jsx("h1",{className:"text-2xl font-semibold text-gray-900 dark:text-white",children:"Upload Files"})]})}),c&&r.jsx("div",{className:"mb-6 bg-red-50 dark:bg-red-900/50 border border-red-200 dark:border-red-500/50 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg",children:c}),r.jsxs("div",{className:"max-w-3xl",children:[r.jsxs("div",{className:"mb-6 space-y-6",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"property_id",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Select Property (Optional)"}),r.jsxs("select",{id:"property_id",name:"property_id",value:j.property_id,onChange:e=>{_((r=>({...r,property_id:e.target.value,job_id:""})))},className:"w-full rounded-lg bg-white dark:bg-[#1E293B] border-gray-300 dark:border-[#2D3B4E] text-gray-900 dark:text-white",children:[r.jsx("option",{value:"",children:"Select a property..."}),m.map((e=>r.jsx("option",{value:e.id,children:e.property_name},e.id)))]})]}),j.property_id&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"job_id",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Select Job (Optional)"}),r.jsxs("select",{id:"job_id",name:"job_id",value:j.job_id,onChange:e=>_((r=>({...r,job_id:e.target.value}))),className:"w-full rounded-lg bg-white dark:bg-[#1E293B] border-gray-300 dark:border-[#2D3B4E] text-gray-900 dark:text-white",children:[r.jsx("option",{value:"",children:"Select a job..."}),h.map((e=>r.jsx("option",{value:e.id,children:`WO-${String(e.work_order_num).padStart(6,"0")} - Unit ${e.unit_number}`},e.id)))]})]}),!j.property_id&&r.jsxs("div",{children:[r.jsx("label",{htmlFor:"folder_id",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Select Folder (Optional)"}),r.jsxs("select",{id:"folder_id",name:"folder_id",value:j.folder_id,onChange:e=>_((r=>({...r,folder_id:e.target.value}))),className:"w-full rounded-lg bg-white dark:bg-[#1E293B] border-gray-300 dark:border-[#2D3B4E] text-gray-900 dark:text-white",children:[r.jsx("option",{value:"",children:"Select a folder..."}),f.map((e=>r.jsx("option",{value:e.id,children:e.name},e.id)))]})]})]}),r.jsxs("div",{className:"mb-6 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 dark:hover:border-blue-500 transition-colors",onClick:()=>document.getElementById("file-input")?.click(),onDrop:e=>{e.preventDefault(),e.dataTransfer.files&&g(Array.from(e.dataTransfer.files))},onDragOver:e=>{e.preventDefault()},children:[r.jsx("input",{id:"file-input",type:"file",multiple:!0,onChange:e=>{e.target.files&&g(Array.from(e.target.files))},className:"hidden"}),r.jsx(d,{className:"mx-auto h-12 w-12 text-gray-500 dark:text-gray-400 mb-4"}),r.jsx("p",{className:"text-gray-700 dark:text-gray-400 mb-2",children:"Drag and drop files here, or click to select files"}),r.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-500",children:"Maximum file size: 50MB"})]}),u.length>0&&r.jsxs("div",{className:"mb-6 bg-white dark:bg-[#1E293B] rounded-lg overflow-hidden shadow",children:[r.jsx("div",{className:"px-6 py-4 border-b border-gray-200 dark:border-[#2D3B4E]",children:r.jsx("h3",{className:"text-gray-900 dark:text-white font-medium",children:"Selected Files"})}),r.jsx("div",{className:"divide-y divide-gray-200 dark:divide-[#2D3B4E]",children:u.map(((e,t)=>r.jsxs("div",{className:"px-6 py-4 flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsx("p",{className:"text-gray-900 dark:text-white font-medium",children:e.name}),r.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:s(e.size)})]}),r.jsx("button",{onClick:()=>{const e=[...u];e.splice(t,1),g(e)},className:"text-gray-600 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-500 transition-colors",children:r.jsx(i,{className:"h-5 w-5"})})]},t)))})]}),r.jsxs("div",{className:"flex justify-end space-x-3",children:[r.jsx("button",{type:"button",onClick:()=>o("/dashboard/files"),className:"px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-400 bg-white dark:bg-[#1E293B] border border-gray-300 dark:border-[#2D3B4E] rounded-lg hover:bg-gray-50 dark:hover:bg-[#2D3B4E] transition-colors",children:"Cancel"}),r.jsx("button",{type:"button",onClick:async()=>{if(0!==u.length){n(!0),p(null);try{const{data:t}=await e.auth.getUser();if(!t.user)throw new Error("Not authenticated");let a=null;if(!j.property_id&&!j.folder_id){const{data:r,error:d}=await e.from("files").select("id").eq("name","General").eq("type","folder/directory").eq("path","/").single();if(d&&"PGRST116"!==d.code)throw d;if(r)a=r.id;else{const{data:r,error:d}=await e.from("files").insert({name:"General",path:"/",size:0,type:"folder/directory",uploaded_by:t.user.id}).select().single();if(d)throw d;a=r.id}}for(const d of u){const i=(r=d.name,`${Date.now()}_${r.replace(/[^a-zA-Z0-9.-]/g,"_").toLowerCase()}`);let o,s;if(j.property_id)j.job_id?(o=`/properties/${j.property_id}/jobs/${j.job_id}`,s=`properties/${j.property_id}/jobs/${j.job_id}/${i}`):(o=`/properties/${j.property_id}`,s=`properties/${j.property_id}/${i}`);else if(j.folder_id){const e=f.find((e=>e.id===j.folder_id));o=e?.path||"/",s=`${e?.path||""}/${i}`.replace(/^\/+/,"")}else o="/general",s=`general/${i}`;const{data:l,error:n}=await e.storage.from("files").upload(s,d,{cacheControl:"3600",upsert:!1});if(n)throw n;const{error:c}=await e.from("files").insert({name:i,path:o,size:d.size,type:d.type,uploaded_by:t.user.id,property_id:j.property_id||null,job_id:j.job_id||null,folder_id:j.folder_id||a});if(c)throw c}o("/dashboard/files")}catch(t){p(t instanceof Error?t.message:"Failed to upload files")}finally{n(!1)}var r}else p("Please select files to upload")},disabled:l||0===u.length,className:"inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50",children:l?"Uploading...":"Upload Files"})]})]})]})}function s(e){if(0===e)return"0 Bytes";const r=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,r)).toFixed(2))+" "+["Bytes","KB","MB","GB"][r]}export{o as FileUpload};

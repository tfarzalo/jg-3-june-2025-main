import{s as e,j as r,b as t}from"./index-BXIsiie0.js";import{r as a}from"./react-vendor--AdGielI.js";import{i as s,a as d,f as l}from"./dateUtils-lps6FOOV.js";import{k as n,a3 as i,E as o,aa as c,g as x,c as m,r as h,aj as g,j as u,x as b,p as y}from"./ui-a3QeRpHh.js";import{f as p,p as j,b as f,s as _,a as v}from"./utils-D-HhOMZR.js";import"./supabase-Dq0wjmmz.js";function k(){const[k,N]=a.useState(!0),[w,E]=a.useState(!1),[S,A]=a.useState(null),[C,D]=a.useState([]),[B,z]=a.useState([]),[F,O]=a.useState([]),[U,M]=a.useState({}),[J,P]=a.useState([]),[T,$]=a.useState(null),[R,W]=a.useState(!1),[q,I]=a.useState(0),[L,Y]=a.useState(new Date),[G,H]=a.useState(!1);a.useEffect((()=>{Promise.all([K(),Q()]).finally((()=>{N(!1)}))}),[q]),a.useEffect((()=>{if(0===C.length)return void z([]);const e=C.filter((e=>s(e.scheduled_date,L)));z(e)}),[C,L]),a.useEffect((()=>{const e={};C.forEach((r=>{r.assigned_to&&(e[r.id]=r.assigned_to)})),M(e),P([])}),[C]);const K=async()=>{try{const{data:r,error:t}=await e.from("job_phases").select("id").in("job_phase_label",["Job Request","Work Order","Pending Work Order"]);if(t)throw t;if(!r||0===r.length)throw new Error("No active job phases found");const{data:a,error:s}=await e.from("jobs").select("\n          id,\n          work_order_num,\n          unit_number,\n          scheduled_date,\n          assigned_to,\n          created_by,\n          property:properties (\n            id,\n            property_name\n          ),\n          unit_size:unit_sizes (\n            id,\n            unit_size_label\n          ),\n          job_phase:current_phase_id (\n            id,\n            job_phase_label,\n            color_dark_mode\n          ),\n          job_type:job_types (\n            id,\n            job_type_label\n          )\n        ").in("current_phase_id",r.map((e=>e.id))).order("scheduled_date",{ascending:!0});if(s)throw s;return D((a||[]).map((e=>({...e,property:Array.isArray(e.property)?e.property[0]:e.property,unit_size:Array.isArray(e.unit_size)?e.unit_size[0]:e.unit_size,job_phase:Array.isArray(e.job_phase)?e.job_phase[0]:e.job_phase,job_type:Array.isArray(e.job_type)?e.job_type[0]:e.job_type})))),a}catch(r){return A(r instanceof Error?r.message:"Failed to fetch jobs"),[]}},Q=async()=>{try{const{data:r,error:t}=await e.from("profiles").select("id, full_name, email, avatar_url, work_schedule").eq("role","subcontractor").order("full_name");if(t)throw t;const a=(r||[]).map((e=>({...e,assigned_jobs:[]})));return O(a),a}catch(r){return A(r instanceof Error?r.message:"Failed to fetch subcontractors"),[]}},V=e=>{e.preventDefault()},X=e=>{T&&(U[T.id]&&U[T.id]!==e&&P((e=>e.filter((e=>e!==T.id)))),M((r=>({...r,[T.id]:e}))),W(!0),$(null))},Z=e=>`WO-${String(e).padStart(6,"0")}`,ee=B.filter((e=>!U[e.id]||J.includes(e.id))),re=r=>{if(!r)return;const{data:t}=e.storage.from("avatars").getPublicUrl(r);return t.publicUrl},te=()=>{Y(new Date)};return k?r.jsx("div",{className:"flex items-center justify-center h-full",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):r.jsxs("div",{className:"p-6 bg-gray-100 dark:bg-[#0F172A] h-screen overflow-hidden",children:[r.jsxs("div",{className:"flex items-center justify-between mb-8",children:[r.jsxs("div",{className:"flex items-center space-x-3",children:[r.jsx(n,{className:"h-8 w-8 text-gray-600 dark:text-gray-400"}),r.jsx("h1",{className:"text-2xl font-semibold text-gray-900 dark:text-white",children:"Sub Scheduler"})]}),r.jsxs("div",{className:"flex space-x-3",children:[r.jsxs("button",{onClick:()=>I((e=>e+1)),className:"inline-flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-sm font-medium rounded-lg transition-colors hover:bg-gray-300 dark:hover:bg-gray-600",disabled:w,children:[r.jsx(i,{className:"h-4 w-4 mr-2"}),"Refresh"]}),r.jsxs("button",{onClick:async()=>{try{E(!0),A(null);const r=Object.entries(U).map((([e,r])=>{const t=C.find((r=>r.id===e));if(!t)throw new Error(`Job ${e} not found`);return{id:e,property_id:t.property.id,unit_number:t.unit_number,unit_size_id:t.unit_size.id,job_type_id:t.job_type.id,scheduled_date:t.scheduled_date,created_by:t.created_by,assigned_to:r}})),a=J.map((e=>{const r=C.find((r=>r.id===e));if(!r)throw new Error(`Job ${e} not found`);return{id:e,property_id:r.property.id,unit_number:r.unit_number,unit_size_id:r.unit_size.id,job_type_id:r.job_type.id,scheduled_date:r.scheduled_date,created_by:r.created_by,assigned_to:null}})),s=[...r,...a],d=10;for(let t=0;t<s.length;t+=d){const r=s.slice(t,t+d),{error:a}=await e.from("jobs").upsert(r);if(a)throw a}t.success("Assignments saved successfully"),W(!1),P([]),I((e=>e+1))}catch(r){A(r instanceof Error?r.message:"Failed to save assignments"),t.error("Error saving assignments: "+(r instanceof Error?r.message:"Unknown error"))}finally{E(!1)}},className:"inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50",disabled:!R||w,children:[r.jsx(o,{className:"h-4 w-4 mr-2"}),w?"Saving...":"Confirm Schedule"]})]})]}),S&&r.jsx("div",{className:"mb-6 bg-red-50 dark:bg-red-900/50 border border-red-200 dark:border-red-500/50 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg",children:S}),r.jsxs("div",{className:"mb-6 bg-white dark:bg-[#1E293B] rounded-lg p-4 shadow-lg",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("button",{onClick:()=>{Y(_(L,1))},className:"p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-[#0F172A]",children:r.jsx(c,{className:"h-5 w-5"})}),r.jsxs("div",{className:"relative",children:[r.jsxs("button",{onClick:()=>H(!G),className:"flex items-center px-4 py-2 bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors",children:[r.jsx(x,{className:"h-5 w-5 mr-2"}),r.jsx("span",{className:"font-medium",children:v(L,"America/New_York","EEEE, MMMM d, yyyy")}),r.jsx(m,{className:"h-4 w-4 ml-2"})]}),G&&r.jsxs("div",{className:"absolute mt-2 p-2 bg-white dark:bg-[#1E293B] rounded-lg shadow-lg z-10 border border-gray-200 dark:border-[#2D3B4E]",children:[r.jsx("div",{className:"p-2",children:r.jsx("input",{type:"date",value:p(L,"yyyy-MM-dd"),onChange:e=>{e.target.value&&(Y(j(e.target.value)),H(!1))},className:"w-full px-3 py-2 bg-gray-50 dark:bg-[#0F172A] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-900 dark:text-white"})}),r.jsxs("div",{className:"mt-2 flex justify-between",children:[r.jsx("button",{onClick:()=>{te(),H(!1)},className:"text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 px-3 py-1",children:"Today"}),r.jsx("button",{onClick:()=>H(!1),className:"text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 px-3 py-1",children:"Close"})]})]})]}),r.jsx("button",{onClick:()=>{Y(f(L,1))},className:"p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-[#0F172A]",children:r.jsx(m,{className:"h-5 w-5"})})]}),r.jsxs("div",{className:"mt-4 flex justify-between items-center",children:[r.jsxs("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:[r.jsx("span",{className:"font-medium",children:B.length})," job",1!==B.length?"s":""," scheduled for this date"]}),r.jsx("button",{onClick:te,className:"text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300",children:"Today"})]})]}),0===B.length?r.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg shadow-lg p-8 text-center",children:[r.jsx(n,{className:"h-12 w-12 mx-auto mb-4 text-gray-400 dark:text-gray-600"}),r.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"No Jobs Scheduled"}),r.jsxs("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:["There are no jobs scheduled for ",L?d(L.toISOString()):"this date","."]}),r.jsxs("div",{className:"flex justify-center space-x-4",children:[r.jsx("button",{onClick:()=>Y(f(L,-1)),className:"px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors",children:"Previous Day"}),r.jsx("button",{onClick:()=>Y(f(L,1)),className:"px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors",children:"Next Day"})]})]}):r.jsxs("div",{className:"flex flex-col lg:flex-row gap-6 h-[calc(100vh-280px)]",children:[r.jsxs("div",{className:"lg:w-1/2 bg-white dark:bg-[#1E293B] rounded-lg shadow-lg overflow-hidden",children:[r.jsx("div",{className:"p-4 border-b border-gray-200 dark:border-[#2D3B4E] bg-gray-50 dark:bg-[#0F172A]",children:r.jsxs("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white flex items-center",children:[r.jsx(h,{className:"h-5 w-5 mr-2 text-blue-500"}),"Unassigned Jobs",r.jsx("span",{className:"ml-2 px-2 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 text-xs rounded-full",children:ee.length})]})}),r.jsx("div",{className:"p-4 h-[calc(100vh-360px)] overflow-y-auto",onDragOver:V,children:0===ee.length?r.jsxs("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:[r.jsx(g,{className:"h-12 w-12 mx-auto mb-2 text-green-500"}),r.jsx("p",{children:"All jobs have been assigned"})]}):r.jsx("div",{className:"space-y-3",children:ee.map((e=>r.jsx("div",{className:"bg-gray-50 dark:bg-[#0F172A] rounded-lg p-3 border-l-4 cursor-grab",style:{borderLeftColor:e.job_phase?.color_dark_mode||"#4B5563"},draggable:!0,onDragStart:()=>(e=>{$(e)})(e),children:r.jsxs("div",{className:"flex justify-between items-start",children:[r.jsxs("div",{children:[r.jsx("h4",{className:"text-sm font-medium text-gray-900 dark:text-white",children:Z(e.work_order_num)}),r.jsxs("p",{className:"text-xs text-gray-600 dark:text-gray-400 mt-1",children:[e.property.property_name," - Unit ",e.unit_number]}),r.jsxs("div",{className:"flex items-center mt-1",children:[r.jsx(h,{className:"h-3 w-3 text-gray-500 dark:text-gray-400 mr-1"}),r.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-500",children:l(e.scheduled_date)})]})]}),r.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full",style:{backgroundColor:`${e.job_phase?.color_dark_mode||"#4B5563"}20`,color:e.job_phase?.color_dark_mode||"#4B5563"},children:e.job_type.job_type_label})]})},e.id)))})})]}),r.jsx("div",{className:"lg:w-1/2 overflow-y-auto",children:0===F.length?r.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg shadow-lg p-8 text-center",children:[r.jsx(u,{className:"h-12 w-12 mx-auto mb-4 text-gray-400 dark:text-gray-600"}),r.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"No Subcontractors Found"}),r.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"There are no subcontractors available for assignment. Add subcontractors with the 'subcontractor' role to get started."})]}):r.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:F.map((e=>{const t=(a=e.id,B.filter((e=>U[e.id]===a&&!J.includes(e.id))));var a;return r.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg shadow-lg overflow-hidden h-[230px] flex flex-col",children:[r.jsx("div",{className:"p-3 border-b border-gray-200 dark:border-[#2D3B4E] bg-gray-50 dark:bg-[#0F172A]",children:r.jsxs("div",{className:"flex items-center",children:[r.jsx("div",{className:"flex-shrink-0 mr-2",children:e.avatar_url?r.jsx("img",{src:re(e.avatar_url),alt:e.full_name,className:"h-8 w-8 rounded-full object-cover"}):r.jsx("div",{className:"h-8 w-8 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center",children:r.jsx("span",{className:"text-purple-800 dark:text-purple-300 font-medium",children:e.full_name.charAt(0)})})}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsx("h2",{className:"text-sm font-semibold text-gray-900 dark:text-white truncate",children:e.full_name}),r.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 truncate",children:[t.length," job",1!==t.length?"s":""," for ",L?d(L.toISOString()):"this date"]})]})]})}),r.jsx("div",{className:"p-3 flex-1 overflow-y-auto",onDragOver:V,onDrop:()=>X(e.id),children:0===t.length?r.jsx("div",{className:"border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg p-4 text-center h-full flex items-center justify-center",onDragOver:V,onDrop:()=>X(e.id),children:r.jsxs("div",{children:[r.jsx(b,{className:"h-6 w-6 mx-auto mb-2 text-gray-400 dark:text-gray-600"}),r.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Drag jobs here"})]})}):r.jsx("div",{className:"space-y-2",children:t.map((e=>r.jsx("div",{className:"bg-gray-50 dark:bg-[#0F172A] rounded-lg p-2 border-l-4 group",style:{borderLeftColor:e.job_phase?.color_dark_mode||"#4B5563"},children:r.jsxs("div",{className:"flex justify-between items-start",children:[r.jsxs("div",{className:"min-w-0 flex-1",children:[r.jsx("h4",{className:"text-xs font-medium text-gray-900 dark:text-white truncate",children:Z(e.work_order_num)}),r.jsxs("p",{className:"text-xs text-gray-600 dark:text-gray-400 truncate",children:[e.property.property_name," - Unit ",e.unit_number]}),r.jsxs("div",{className:"flex items-center mt-1",children:[r.jsx(h,{className:"h-3 w-3 text-gray-500 dark:text-gray-400 mr-1"}),r.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-500 truncate",children:l(e.scheduled_date)})]})]}),r.jsx("button",{onClick:()=>(e=>{M((r=>{const t={...r};return delete t[e],t}));const r=C.find((r=>r.id===e));r&&r.assigned_to&&P((r=>[...r,e])),W(!0)})(e.id),className:"text-red-500 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 opacity-0 group-hover:opacity-100 transition-opacity ml-1 flex-shrink-0",title:"Remove assignment",children:r.jsx(y,{className:"h-4 w-4"})})]})},e.id)))})})]},e.id)}))})})]})]})}export{k as default};

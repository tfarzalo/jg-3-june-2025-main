import{u as e,s as t,j as r}from"./index-nRXVoRx_.js";import{k as a,u as i,r as s}from"./react-vendor--AdGielI.js";import{u as o}from"./useSessionValidation-Dpzv_eLL.js";import{z as l,P as n,E as d,N as c,D as u,p as g}from"./ui-a3QeRpHh.js";import"./supabase-Dq0wjmmz.js";function m(){const{propertyId:m}=a(),x=i(),{session:b}=e();o();const[y,h]=s.useState(!1),[f,p]=s.useState(null),[w,j]=s.useState([]),[v,k]=s.useState([]),[_,N]=s.useState([]),[C,S]=s.useState([]),[E,A]=s.useState(!1),[z,B]=s.useState(null),[P,I]=s.useState({}),[D,F]=s.useState(!1),[q,U]=s.useState(""),[H,T]=s.useState(!1),[R,G]=s.useState(""),[L,$]=s.useState(""),[M,O]=s.useState(""),[Y,J]=s.useState(!1),[Q,V]=s.useState(""),[K,W]=s.useState(null);s.useEffect((()=>{if(!m)return void x("/dashboard/properties");(async()=>{const{data:e,error:r}=await t.from("properties").select("property_name").eq("id",m).single();!r&&e&&O(e.property_name)})(),Promise.all([X(),Z()])}),[m,x]),s.useEffect((()=>{m&&w.length>0&&_.length>0&&ee()}),[m,w,_]);const X=async()=>{try{const e=[{name:"Regular Paint",description:"Standard interior and exterior painting services",sort_order:1},{name:"Ceiling Paint",description:"Specialized ceiling painting services",sort_order:2},{name:"Unit with High Ceilings",description:"Billing for units with high ceilings",sort_order:3},{name:"Extra Charges",description:"Additional charges for special services or materials",sort_order:4},{name:"Miscellaneous",description:"Miscellaneous billing items",sort_order:5}],{error:r}=await t.from("job_categories").upsert(e,{onConflict:"name"}),{data:a,error:i}=await t.from("job_categories").select("*").order("sort_order");if(i)throw p("Failed to load job categories for selection."),i;j(a||[])}catch(e){}},Z=async()=>{try{const{data:e,error:r}=await t.from("unit_sizes").select("*").order("unit_size_label");if(r)throw r;N(e||[])}catch(e){}},ee=async()=>{try{const{data:e,error:r}=await t.from("billing_categories").select("*").eq("property_id",m);if(r)throw r;k(e||[]);const a=e?.some((e=>"Extra Charges"===e.name));let i=null;if(a)i=e.find((e=>"Extra Charges"===e.name))?.id;else{const{data:e,error:r}=await t.from("billing_categories").insert([{property_id:m,name:"Extra Charges",description:"Additional charges for special services or materials",sort_order:4}]).select().single();if(r)throw r;i=e.id,k((t=>[...t,e]));const{error:a}=await t.from("billing_details").insert([{property_id:m,category_id:i,unit_size_id:_[0]?.id,bill_amount:40,sub_pay_amount:20,profit_amount:null,is_hourly:!0}]);if(a)throw a}const{data:s,error:o}=await t.from("billing_details").select("*").eq("property_id",m);if(o)throw o;if(S(s||[]),i&&!s?.some((e=>e.category_id===i))){const{error:e}=await t.from("billing_details").insert([{property_id:m,category_id:i,unit_size_id:_[0]?.id,bill_amount:40,sub_pay_amount:20,profit_amount:null,is_hourly:!0}]);if(e)throw e;const{data:r,error:a}=await t.from("billing_details").select("*").eq("property_id",m);if(a)throw a;S(r||[])}}catch(e){p("Failed to load existing billing information.")}};s.useEffect((()=>{const e={};C.forEach((t=>{e[t.category_id]||(e[t.category_id]=[]),e[t.category_id].push({id:crypto.randomUUID(),unitSizeId:t.unit_size_id,billAmount:t.bill_amount.toString(),subPayAmount:t.sub_pay_amount.toString(),isHourly:t.is_hourly})})),I(e)}),[C]);const te=(e,t,r,a)=>{I((i=>({...i,[e]:i[e].map((e=>e.id===t?{...e,[r]:a}:e))}))),A(!0)};return r.jsx("div",{className:"p-6 bg-gray-100 dark:bg-[#0F172A] min-h-screen",children:r.jsxs("div",{className:"max-w-7xl mx-auto space-y-8",children:[M&&r.jsxs("div",{className:"text-xs text-gray-400 mb-1",children:["Billing details for: ",r.jsx("span",{className:"font-medium text-gray-500",children:M})]}),r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"flex items-center space-x-4",children:[r.jsx("button",{onClick:()=>x(`/dashboard/properties/${m}`),className:"inline-flex items-center text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white",children:r.jsx(l,{className:"h-5 w-5"})}),r.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:"Property Billing Details"})]}),r.jsxs("div",{className:"flex space-x-3",children:[r.jsxs("button",{onClick:()=>T(!0),className:"inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors",children:[r.jsx(n,{className:"h-4 w-4 mr-2"}),"Add Billing Category"]}),r.jsxs("button",{onClick:async()=>{h(!0),p(null);try{const e=[];for(const t in P)for(const r of P[t]){const a=v.find((e=>e.id===t));if(!a||a.property_id!==m)continue;if("Extra Charges"===a.name){if(!r.billAmount||!r.subPayAmount)continue}else if(!r.unitSizeId||!r.billAmount||!r.subPayAmount)continue;const i=parseFloat(r.billAmount),s=parseFloat(r.subPayAmount),o=r.isHourly?null:i-s;e.push({property_id:m,category_id:t,unit_size_id:"Extra Charges"===a.name?_[0]?.id:r.unitSizeId,bill_amount:i,sub_pay_amount:s,profit_amount:o,is_hourly:"Extra Charges"===a.name||r.isHourly})}const{error:r}=await t.from("billing_details").delete().eq("property_id",m);if(r)throw r;if(e.length>0){const{error:r}=await t.from("billing_details").insert(e);if(r)throw r}A(!1),x(`/dashboard/properties/${m}`)}catch(e){p(e instanceof Error?e.message:"Failed to save billing details.")}finally{h(!1)}},disabled:y||!E,className:"inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50",children:[r.jsx(d,{className:"h-4 w-4 mr-2"}),y?"Saving...":"Save All Changes"]}),r.jsx("button",{onClick:()=>x(`/dashboard/properties/${m}`),className:"px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-400 bg-white dark:bg-[#1E293B] border border-gray-300 dark:border-[#2D3B4E] rounded-lg hover:bg-gray-50 dark:hover:bg-[#2D3B4E] transition-colors",children:"Cancel"})]})]}),f&&r.jsx("div",{className:"bg-red-50 dark:bg-red-900/50 border border-red-200 dark:border-red-500/50 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg",children:f}),r.jsx("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 shadow",children:r.jsx("div",{className:"space-y-4",children:v.map((e=>{const t=e.id;return r.jsxs("div",{className:"bg-gray-50 dark:bg-[#0F172A] rounded-lg p-4",children:[r.jsxs("div",{className:"flex items-center justify-between mb-4",children:[r.jsxs("div",{children:[r.jsx("h3",{className:"text-gray-900 dark:text-white font-medium",children:e.name}),e.description&&r.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:e.description})]}),r.jsx("button",{onClick:()=>B(t),className:"text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300",children:r.jsx(c,{className:"h-4 w-4"})})]}),r.jsxs("div",{className:"space-y-4",children:[P[t]?.map((a=>r.jsxs("div",{className:"flex items-center space-x-4",children:["Extra Charges"!==e.name?r.jsxs("div",{className:"flex items-center space-x-2 flex-1",children:[r.jsxs("select",{value:a.unitSizeId,onChange:e=>te(t,a.id,"unitSizeId",e.target.value),className:"flex-1 h-11 px-4 bg-white dark:bg-[#1E293B] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",children:[r.jsx("option",{value:"",children:"Select Unit Size"}),_.map((e=>r.jsx("option",{value:e.id,children:e.unit_size_label},e.id)))]}),r.jsx("button",{onClick:()=>{W({propertyBillingCategoryId:t,lineItemId:a.id}),J(!0)},className:"p-2 text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300",title:"Add new unit size",children:r.jsx(n,{className:"h-4 w-4"})})]}):r.jsx("div",{className:"flex-1 text-sm text-gray-600 dark:text-gray-400",children:"Hourly Rates"}),r.jsxs("div",{className:"flex flex-col space-y-1",children:[r.jsx("label",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Extra Charges"===e.name?"Billed Amount":"Bill Amount"}),r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx(u,{className:"h-4 w-4 text-gray-500 dark:text-gray-400"}),r.jsx("input",{type:"number",value:a.billAmount,onChange:e=>te(t,a.id,"billAmount",e.target.value),placeholder:a.isHourly?"Hourly Rate":"Bill Amount",className:"w-32 h-11 px-4 bg-white dark:bg-[#1E293B] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),r.jsxs("div",{className:"flex flex-col space-y-1",children:[r.jsx("label",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Extra Charges"===e.name?"Sub Pay Amount":"Sub Pay"}),r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx(u,{className:"h-4 w-4 text-gray-500 dark:text-gray-400"}),r.jsx("input",{type:"number",value:a.subPayAmount,onChange:e=>te(t,a.id,"subPayAmount",e.target.value),placeholder:a.isHourly?"Sub Hourly Rate":"Sub Pay",className:"w-32 h-11 px-4 bg-white dark:bg-[#1E293B] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"})]})]}),"Extra Charges"!==e.name&&r.jsxs("div",{className:"flex items-center",children:[r.jsx("input",{type:"checkbox",checked:a.isHourly,onChange:e=>te(t,a.id,"isHourly",e.target.checked),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),r.jsx("label",{className:"ml-2 text-sm text-gray-700 dark:text-gray-300",children:"Hourly Rate"})]}),r.jsx("button",{onClick:()=>((e,t)=>{I((r=>({...r,[e]:r[e].filter((e=>e.id!==t))}))),A(!0)})(t,a.id),className:"text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300",children:r.jsx(g,{className:"h-4 w-4"})})]},a.id))),r.jsxs("button",{onClick:()=>(e=>{I((t=>({...t,[e]:[...t[e]||[],{id:crypto.randomUUID(),unitSizeId:"",billAmount:"",subPayAmount:"",isHourly:!1}]}))),A(!0)})(t),className:"inline-flex items-center px-4 py-2 text-sm font-medium text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300",children:[r.jsx(n,{className:"h-4 w-4 mr-2"}),"Add New Item"]})]})]},t)}))})}),D&&r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4",children:r.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 w-full max-w-md",children:[r.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Add Billing Item"}),r.jsx("div",{className:"space-y-4",children:r.jsxs("div",{children:[r.jsx("label",{htmlFor:"jobCategorySelect",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Select Job Category"}),r.jsxs("select",{id:"jobCategorySelect",value:q,onChange:e=>U(e.target.value),className:"w-full h-11 px-4 bg-gray-50 dark:bg-[#0F172A] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",children:[r.jsx("option",{value:"",children:"Select a category"}),w.map((e=>r.jsx("option",{value:e.id,children:e.name},e.id)))]})]})}),r.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[r.jsx("button",{type:"button",onClick:()=>F(!1),className:"px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500",children:"Cancel"}),r.jsx("button",{type:"button",onClick:()=>(async e=>{if(e&&m){h(!0),p(null);try{const r=w.find((t=>t.id===e));if(!r)throw new Error("Selected category not found");const{data:a,error:i}=await t.from("billing_categories").select("id").eq("property_id",m).eq("name",r.name).single();if(i&&"PGRST116"!==i.code)throw i;if(a)return p("This category already exists for this property"),void h(!1);const{data:s,error:o}=await t.from("billing_categories").insert([{property_id:m,name:r.name,description:r.description,sort_order:r.sort_order}]).select("id").single();if(o)throw o;I((e=>({...e,[s.id]:[{id:crypto.randomUUID(),unitSizeId:"",billAmount:"",subPayAmount:"",isHourly:!1}]}))),await ee(),F(!1),A(!0)}catch(r){p(r instanceof Error?r.message:"Failed to add billing category.")}finally{h(!1)}}})(q),disabled:!q,className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",children:"Add Selected Category"})]})]})}),z&&r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4",children:r.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 w-full max-w-md",children:[r.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Delete Billing Category from Property"}),r.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6",children:"Are you sure you want to remove this billing category and all its line items from this property? This action cannot be undone."}),r.jsxs("div",{className:"flex justify-end gap-2",children:[r.jsx("button",{type:"button",onClick:()=>B(null),className:"px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500",children:"Cancel"}),r.jsx("button",{type:"button",onClick:()=>(async e=>{h(!0),p(null);try{const{error:r}=await t.from("billing_details").delete().eq("category_id",e),{error:a}=await t.from("billing_categories").delete().eq("id",e).eq("property_id",m);if(a)throw a;await ee(),B(null),A(!0)}catch(r){p(r instanceof Error?r.message:"Failed to delete billing category entry.")}finally{h(!1)}})(z),className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500",children:"Delete from Property"})]})]})}),H&&r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4",children:r.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 w-full max-w-md",children:[r.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Add New Category"}),r.jsxs("div",{className:"space-y-4",children:[r.jsxs("div",{children:[r.jsx("label",{htmlFor:"newCategoryName",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Category Name *"}),r.jsx("input",{type:"text",id:"newCategoryName",value:R,onChange:e=>G(e.target.value),className:"w-full h-11 px-4 bg-gray-50 dark:bg-[#0F172A] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter new category name",required:!0})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"newCategoryDescription",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Description (Optional)"}),r.jsx("textarea",{id:"newCategoryDescription",value:L,onChange:e=>$(e.target.value),className:"w-full px-4 py-2 bg-gray-50 dark:bg-[#1E293B] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter category description",rows:3})]})]}),r.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[r.jsx("button",{type:"button",onClick:()=>{T(!1),G(""),$("")},className:"px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500",children:"Cancel"}),r.jsx("button",{type:"button",onClick:()=>(async(e,r)=>{if(!m)return;if(!e.trim())return void p("Category name is required");if(!b)return void p("You must be logged in to add categories");h(!0),p(null);const a=setTimeout((()=>{p("Operation timed out. Please try again."),h(!1)}),3e4);try{const{data:a,error:i}=await t.from("job_categories").select("id, name").eq("name",e).single();if(i&&"PGRST116"!==i.code)throw i;if(a){const{data:a,error:i}=await t.from("billing_categories").select("id").eq("property_id",m).eq("name",e).single();if(i&&"PGRST116"!==i.code)throw i;if(a)throw new Error("This category already exists for this property");const{data:s,error:o}=await t.from("billing_categories").insert([{property_id:m,name:e,description:r,sort_order:v.length+1}]).select().single();if(o)throw o;I((e=>({...e,[s.id]:[{id:crypto.randomUUID(),unitSizeId:"",billAmount:"",subPayAmount:"",isHourly:!1}]}))),await ee(),T(!1),G(""),$(""),A(!0)}else{const{data:a,error:i}=await t.from("job_categories").insert([{name:e,description:r,sort_order:w.length+1}]).select().single();if(i)throw"23505"===i.code?new Error("A category with this name already exists"):"42501"===i.code?new Error("Permission denied. You may not have access to create categories."):i;const{data:s,error:o}=await t.from("billing_categories").insert([{property_id:m,name:e,description:r,sort_order:v.length+1}]).select().single();if(o)throw o;I((e=>({...e,[s.id]:[{id:crypto.randomUUID(),unitSizeId:"",billAmount:"",subPayAmount:"",isHourly:!1}]}))),await X(),await ee(),T(!1),G(""),$(""),A(!0)}}catch(i){const e=i instanceof Error?i.message:"Failed to add new category.";p(e)}finally{clearTimeout(a),h(!1)}})(R,L),disabled:!R.trim()||y,className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",children:y?"Adding...":"Add Category"})]})]})}),Y&&r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4",children:r.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 w-full max-w-md",children:[r.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Add New Unit Size"}),r.jsx("div",{className:"space-y-4",children:r.jsxs("div",{children:[r.jsx("label",{htmlFor:"newUnitSizeLabel",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Unit Size Label *"}),r.jsx("input",{type:"text",id:"newUnitSizeLabel",value:Q,onChange:e=>V(e.target.value),className:"w-full h-11 px-4 bg-gray-50 dark:bg-[#0F172A] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"e.g., 1 Bed / 1 Bath",required:!0})]})}),r.jsxs("div",{className:"mt-6 flex justify-end gap-2",children:[r.jsx("button",{type:"button",onClick:()=>J(!1),className:"px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500",children:"Cancel"}),r.jsx("button",{type:"button",onClick:async()=>{if(Q.trim()&&K){h(!0),p(null);try{const{data:e,error:r}=await t.from("unit_sizes").select("id").eq("unit_size_label",Q.trim()).single();if(r&&"PGRST116"!==r.code)throw r;if(e)throw new Error("This unit size already exists.");const{data:a,error:i}=await t.from("unit_sizes").insert({unit_size_label:Q.trim()}).select().single();if(i)throw i;N((e=>[...e,a].sort(((e,t)=>e.unit_size_label.localeCompare(t.unit_size_label))))),te(K.propertyBillingCategoryId,K.lineItemId,"unitSizeId",a.id),J(!1),V(""),W(null)}catch(e){p(e instanceof Error?e.message:"Failed to add new unit size.")}finally{h(!1)}}},disabled:!Q.trim()||y,className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",children:y?"Saving...":"Save Unit Size"})]})]})})]})})}export{m as BillingDetailsForm};

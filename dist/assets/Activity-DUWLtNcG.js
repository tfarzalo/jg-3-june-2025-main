import{s as e,j as a}from"./index-DSvJvUB2.js";import{r,L as s}from"./react-vendor-BmeRVKJv.js";import{a as t,s as l,p as d}from"./utils-DJWOA4Os.js";import{l as n,m as o,n as i,b as c,X as m,q as x,x as h,r as u}from"./ui-CiwSAYI4.js";import"./supabase-c3qFLfUQ.js";function b(){const[b,g]=r.useState([]),[p,y]=r.useState(!0),[_,f]=r.useState(null),[j,k]=r.useState(""),[w,N]=r.useState(!1),[v,C]=r.useState("all"),[B,E]=r.useState([]),[S,D]=r.useState([]),[L,M]=r.useState([]),[U,F]=r.useState([]);r.useEffect((()=>{$(),A(),T()}),[v,B,S]);const $=async()=>{try{y(!0);let a=e.from("job_phase_changes").select("\n          id,\n          job_id,\n          changed_by,\n          from_phase_id,\n          to_phase_id,\n          change_reason,\n          changed_at\n        ").order("changed_at",{ascending:!1});if("today"===v){const e=t(new Date,"America/New_York","yyyy-MM-dd'T'00:00:00XXX");a=a.gte("changed_at",e)}else if("week"===v){const e=l(new Date,7);a=a.gte("changed_at",e.toISOString())}else if("month"===v){const e=l(new Date,30);a=a.gte("changed_at",e.toISOString())}S.length>0&&(a=a.in("changed_by",S));const{data:r,error:s}=await a;if(s)throw s;if(!r||0===r.length)return g([]),void y(!1);const d=r.map((e=>e.from_phase_id)).filter(Boolean),n=r.map((e=>e.to_phase_id)),o=[...new Set([...d,...n])],i=r.map((e=>e.job_id)),c=r.map((e=>e.changed_by)),{data:m,error:x}=await e.from("job_phases").select("id, job_phase_label, color_dark_mode").in("id",o);if(x)throw x;const h=m.reduce(((e,a)=>(e[a.id]={label:a.job_phase_label,color:a.color_dark_mode},e)),{});let u=r;B.length>0&&(u=r.filter((e=>{const a=h[e.to_phase_id];return a&&B.includes(a.label)})));const{data:b,error:p}=await e.from("jobs").select("\n          id,\n          work_order_num,\n          unit_number,\n          property:properties(\n            property_name\n          )\n        ").in("id",i);if(p)throw p;const _=b.reduce(((e,a)=>(e[a.id]={work_order_num:a.work_order_num,unit_number:a.unit_number,property_name:a.property?.property_name||"Unknown Property"},e)),{}),{data:f,error:j}=await e.from("profiles").select("id, full_name").in("id",c);if(j)throw j;const k=f.reduce(((e,a)=>(e[a.id]=a.full_name,e)),{}),w=u.map((e=>{const a=_[e.job_id]||{work_order_num:0,unit_number:"Unknown",property_name:"Unknown Property"},r=e.from_phase_id?h[e.from_phase_id]:null,s=h[e.to_phase_id];return{id:e.id,job_id:e.job_id,changed_by:e.changed_by,from_phase_id:e.from_phase_id,to_phase_id:e.to_phase_id,change_reason:e.change_reason,changed_at:e.changed_at,from_phase_label:r?.label||null,from_phase_color:r?.color||null,to_phase_label:s?.label||"Unknown Phase",to_phase_color:s?.color||"#4B5563",job_work_order_num:a.work_order_num,job_unit_number:a.unit_number,property_name:a.property_name,user_full_name:k[e.changed_by]||"Unknown User"}}));g(w)}catch(a){f(a instanceof Error?a.message:"Failed to fetch activities")}finally{y(!1)}},A=async()=>{try{const{data:a,error:r}=await e.from("job_phases").select("job_phase_label, color_dark_mode").order("sort_order");if(r)throw r;M(a.map((e=>({label:e.job_phase_label,color:e.color_dark_mode}))))}catch(a){}},T=async()=>{try{const{data:a,error:r}=await e.from("profiles").select("id, full_name").order("full_name");if(r)throw r;F(a.map((e=>({id:e.id,name:e.full_name||"Unknown User"}))))}catch(a){}},P=e=>`WO-${String(e).padStart(6,"0")}`,X=e=>{const a=d(e),r=new Date,s=Math.floor((r.getTime()-a.getTime())/1e3);if(s<60)return"just now";if(s<3600){const e=Math.floor(s/60);return`${e} minute${e>1?"s":""} ago`}if(s<86400){const e=Math.floor(s/3600);return`${e} hour${e>1?"s":""} ago`}if(s<604800){const e=Math.floor(s/86400);return`${e} day${e>1?"s":""} ago`}return t(a,"America/New_York","MMM d, yyyy")},O=e=>{B.includes(e)?E(B.filter((a=>a!==e))):E([...B,e])},R=e=>{S.includes(e)?D(S.filter((a=>a!==e))):D([...S,e])},Y=b.filter((e=>{const a=j.toLowerCase();return e.property_name.toLowerCase().includes(a)||e.job_unit_number.toLowerCase().includes(a)||e.to_phase_label.toLowerCase().includes(a)||e.from_phase_label&&e.from_phase_label.toLowerCase().includes(a)||e.user_full_name&&e.user_full_name.toLowerCase().includes(a)||P(e.job_work_order_num).toLowerCase().includes(a)}));return a.jsxs("div",{className:"p-6 bg-gray-100 dark:bg-[#0F172A] min-h-screen",children:[a.jsx("div",{className:"flex items-center justify-between mb-8",children:a.jsxs("div",{className:"flex items-center space-x-3",children:[a.jsx(n,{className:"h-8 w-8 text-gray-600 dark:text-gray-400"}),a.jsx("h1",{className:"text-2xl font-semibold text-gray-900 dark:text-white",children:"Activity Log"})]})}),a.jsxs("div",{className:"mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[a.jsxs("div",{className:"relative flex-1 max-w-md",children:[a.jsx(o,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),a.jsx("input",{type:"text",placeholder:"Search activities...",value:j,onChange:e=>k(e.target.value),className:"w-full pl-10 pr-4 py-2 bg-white dark:bg-[#1E293B] border border-gray-300 dark:border-[#1E293B] rounded-lg text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),a.jsxs("div",{className:"flex space-x-4",children:[a.jsxs("div",{className:"relative",children:[a.jsxs("button",{onClick:()=>N(!w),className:"flex items-center px-4 py-2 bg-white dark:bg-[#1E293B] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-[#2D3B4E] transition-colors",children:[a.jsx(i,{className:"h-4 w-4 mr-2"}),"Filters",a.jsx(c,{className:"h-4 w-4 ml-2"})]}),w&&a.jsxs("div",{className:"absolute right-0 mt-2 w-64 bg-white dark:bg-[#1E293B] rounded-lg shadow-lg z-10 border border-gray-200 dark:border-[#2D3B4E]",children:[a.jsxs("div",{className:"p-4",children:[a.jsx("h3",{className:"text-sm font-medium text-gray-900 dark:text-white mb-3",children:"Date Range"}),a.jsxs("div",{className:"space-y-2",children:[a.jsxs("label",{className:"flex items-center",children:[a.jsx("input",{type:"radio",name:"dateFilter",value:"all",checked:"all"===v,onChange:()=>C("all"),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 rounded"}),a.jsx("span",{className:"ml-2 text-gray-700 dark:text-gray-300",children:"All time"})]}),a.jsxs("label",{className:"flex items-center",children:[a.jsx("input",{type:"radio",name:"dateFilter",value:"today",checked:"today"===v,onChange:()=>C("today"),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 rounded"}),a.jsx("span",{className:"ml-2 text-gray-700 dark:text-gray-300",children:"Today"})]}),a.jsxs("label",{className:"flex items-center",children:[a.jsx("input",{type:"radio",name:"dateFilter",value:"week",checked:"week"===v,onChange:()=>C("week"),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 rounded"}),a.jsx("span",{className:"ml-2 text-gray-700 dark:text-gray-300",children:"Last 7 days"})]}),a.jsxs("label",{className:"flex items-center",children:[a.jsx("input",{type:"radio",name:"dateFilter",value:"month",checked:"month"===v,onChange:()=>C("month"),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 rounded"}),a.jsx("span",{className:"ml-2 text-gray-700 dark:text-gray-300",children:"Last 30 days"})]})]})]}),a.jsxs("div",{className:"border-t border-gray-200 dark:border-[#2D3B4E] p-4",children:[a.jsx("h3",{className:"text-sm font-medium text-gray-900 dark:text-white mb-3",children:"Job Phases"}),a.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:L.map((e=>a.jsxs("label",{className:"flex items-center",children:[a.jsx("input",{type:"checkbox",checked:B.includes(e.label),onChange:()=>O(e.label),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 rounded"}),a.jsxs("span",{className:"ml-2 flex items-center",style:{color:e.color},children:[a.jsx("span",{className:"w-2 h-2 rounded-full mr-1",style:{backgroundColor:e.color}}),e.label]})]},e.label)))})]}),a.jsxs("div",{className:"border-t border-gray-200 dark:border-[#2D3B4E] p-4",children:[a.jsx("h3",{className:"text-sm font-medium text-gray-900 dark:text-white mb-3",children:"Users"}),a.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:U.map((e=>a.jsxs("label",{className:"flex items-center",children:[a.jsx("input",{type:"checkbox",checked:S.includes(e.id),onChange:()=>R(e.id),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 dark:border-gray-600 rounded"}),a.jsx("span",{className:"ml-2 text-gray-700 dark:text-gray-300",children:e.name})]},e.id)))})]}),a.jsx("div",{className:"border-t border-gray-200 dark:border-[#2D3B4E] p-4 flex justify-end",children:a.jsx("button",{onClick:()=>{C("all"),E([]),D([])},className:"text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300",children:"Reset Filters"})})]})]}),a.jsxs("select",{value:v,onChange:e=>C(e.target.value),className:"px-4 py-2 bg-white dark:bg-[#1E293B] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-700 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500",children:[a.jsx("option",{value:"all",children:"All time"}),a.jsx("option",{value:"today",children:"Today"}),a.jsx("option",{value:"week",children:"Last 7 days"}),a.jsx("option",{value:"month",children:"Last 30 days"})]})]})]}),_&&a.jsx("div",{className:"mb-6 bg-red-50 dark:bg-red-900/50 border border-red-200 dark:border-red-500/50 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg",children:_}),(B.length>0||S.length>0)&&a.jsxs("div",{className:"mb-6 flex flex-wrap gap-2",children:[B.map((e=>a.jsxs("div",{className:"flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300",children:[a.jsx("span",{children:e}),a.jsx("button",{onClick:()=>O(e),className:"ml-2 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300",children:a.jsx(m,{className:"h-4 w-4"})})]},e))),S.map((e=>{const r=U.find((a=>a.id===e));return r?a.jsxs("div",{className:"flex items-center px-3 py-1 rounded-full text-sm bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-300",children:[a.jsx(x,{className:"h-3 w-3 mr-1"}),a.jsx("span",{children:r.name}),a.jsx("button",{onClick:()=>R(e),className:"ml-2 text-purple-600 dark:text-purple-400 hover:text-purple-800 dark:hover:text-purple-300",children:a.jsx(m,{className:"h-4 w-4"})})]},e):null})),a.jsx("button",{onClick:()=>{E([]),D([])},className:"text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 px-3 py-1 bg-gray-100 dark:bg-gray-800 rounded-full",children:"Clear All Filters"})]}),p?a.jsx("div",{className:"flex items-center justify-center py-12",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):0===Y.length?a.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-12 text-center shadow",children:[a.jsx(n,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),a.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"No activity found"}),a.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:j?"Try adjusting your search or filters":"There is no activity to display for the selected filters"})]}):a.jsx("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg shadow overflow-hidden",children:a.jsx("div",{className:"divide-y divide-gray-200 dark:divide-[#2D3B4E]",children:Y.map((e=>{return a.jsx("div",{className:"p-6 hover:bg-gray-50 dark:hover:bg-[#2D3B4E] transition-colors",children:a.jsxs("div",{className:"flex items-start",children:[a.jsx("div",{className:"flex-shrink-0 mr-4",children:a.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center",children:a.jsx(n,{className:"h-5 w-5 text-blue-600 dark:text-blue-400"})})}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("div",{className:"flex items-center justify-between mb-1",children:[a.jsxs("div",{className:"flex items-center",children:[a.jsx(s,{to:`/dashboard/jobs/${e.job_id}`,className:"text-lg font-medium text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400",children:P(e.job_work_order_num)}),a.jsx("span",{className:"mx-2 text-gray-500 dark:text-gray-400",children:"•"}),a.jsxs("span",{className:"text-gray-700 dark:text-gray-300",children:[e.property_name," - Unit ",e.job_unit_number]})]}),a.jsx("span",{className:"text-sm text-gray-500 dark:text-gray-400",children:X(e.changed_at)})]}),a.jsxs("div",{className:"flex items-center mb-2",children:[a.jsx("span",{className:"text-gray-700 dark:text-gray-300 mr-2",children:"Phase changed:"}),e.from_phase_label&&a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium mr-2",style:{backgroundColor:e.from_phase_color||"#4B5563",color:"white"},children:e.from_phase_label}),a.jsx(h,{className:"h-4 w-4 text-gray-500 dark:text-gray-400 mr-2"})]}),a.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium",style:{backgroundColor:e.to_phase_color||"#4B5563",color:"white"},children:e.to_phase_label})]}),e.change_reason&&a.jsxs("div",{className:"mb-2 text-gray-700 dark:text-gray-300",children:[a.jsx("span",{className:"font-medium",children:"Reason:"})," ",e.change_reason]}),a.jsxs("div",{className:"flex items-center text-sm text-gray-500 dark:text-gray-400",children:[a.jsx(x,{className:"h-4 w-4 mr-1"}),a.jsx("span",{children:e.user_full_name||"Unknown User"}),a.jsx("span",{className:"mx-2",children:"•"}),a.jsx(u,{className:"h-4 w-4 mr-1"}),a.jsx("span",{children:(r=e.changed_at,t(d(r),"America/New_York","MMM d, yyyy h:mm a"))})]}),a.jsx("div",{className:"mt-3 flex items-center",children:a.jsxs(s,{to:`/dashboard/jobs/${e.job_id}`,className:"text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 flex items-center",children:["View Job Details",a.jsx(h,{className:"h-4 w-4 ml-1"})]})})]})]})},e.id);var r}))})})]})}export{b as Activity};

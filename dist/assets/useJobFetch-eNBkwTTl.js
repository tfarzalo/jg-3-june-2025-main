import{j as e,b as t,s as r}from"./index-DSvJvUB2.js";import{r as s,L as a}from"./react-vendor-BmeRVKJv.js";import{f as n,c as o,p as l,a as i,P as d}from"./utils-DJWOA4Os.js";import{E as c}from"./pdf-BIHRzquI.js";import{c as u}from"./supabase-c3qFLfUQ.js";import{e as h,a3 as x,A as m,N as b,P as p,Z as g,b as y,m as _,p as j,$ as f,o as w}from"./ui-CiwSAYI4.js";function k(e){return`WO-${String(e).padStart(6,"0")}`}function N(e){try{return i(l(e),"America/New_York","MMM d, yyyy")}catch(t){return e}}function v({title:i,jobs:v,loading:C,error:S,showAddButton:D=!1,addButtonLink:A="/dashboard/jobs/new",isArchive:z=!1,refetch:E}){const[R,$]=s.useState(""),[B,J]=s.useState(!1),[U,O]=s.useState(!1),[T,I]=s.useState(null),[F,L]=s.useState({dateRange:{startDate:n(o(new Date,1),"yyyy-MM-dd"),endDate:n(new Date,"yyyy-MM-dd")},columns:{workOrder:!0,phase:!0,property:!0,unitNumber:!0,unitSize:!0,jobType:!0,scheduledDate:!0,amount:!0,address:!0}}),[M,P]=s.useState({field:"scheduled_date",direction:"asc"}),[W,q]=s.useState([]),[Y,Z]=s.useState(!1),[G,H]=s.useState(!1),[X,V]=s.useState(!1),[Q,K]=s.useState(!1),[ee,te]=s.useState(!1),re=e=>{P((t=>({field:e,direction:t.field===e&&"asc"===t.direction?"desc":"asc"})))},se=e=>{I(e),O(!0),J(!1)},ae=()=>{const e=oe.filter((e=>{const t=l(e.scheduled_date),r=l(F.dateRange.startDate),s=l(F.dateRange.endDate);return t>=r&&t<=s})).map((e=>{const t={};var r;return F.columns.workOrder&&(t["Work Order #"]=k(e.work_order_num)),F.columns.phase&&(t.Phase=e.job_phase?.job_phase_label||""),F.columns.property&&(t.Property=e.property.property_name),F.columns.address&&(t.Address=[(r=e.property).address,r.city,r.state].filter(Boolean).join(", ")),F.columns.unitNumber&&(t["Unit #"]=e.unit_number),F.columns.unitSize&&(t["Unit Size"]=e.unit_size.unit_size_label),F.columns.jobType&&(t["Job Type"]=e.job_type.job_type_label),F.columns.scheduledDate&&(t["Scheduled Date"]=N(e.scheduled_date)),F.columns.amount&&(t.Amount=e.total_billing_amount?`$${e.total_billing_amount.toFixed(2)}`:"$0.00"),t})),t=d.unparse(e),r=new Blob([t],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(r),s.download=`${i.toLowerCase().replace(/\s+/g,"_")}_${n(new Date,"yyyy-MM-dd")}.csv`,s.click()},ne=()=>{const e=new c,t=oe.filter((e=>{const t=l(e.scheduled_date),r=l(F.dateRange.startDate),s=l(F.dateRange.endDate);return t>=r&&t<=s})),r=[],s=[];F.columns.workOrder&&(r.push("WO #"),s.push(20)),F.columns.phase&&(r.push("Phase"),s.push(25)),F.columns.property&&(r.push("Property"),s.push(35)),F.columns.unitNumber&&(r.push("Unit #"),s.push(15)),F.columns.unitSize&&(r.push("Size"),s.push(15)),F.columns.jobType&&(r.push("Type"),s.push(20)),F.columns.scheduledDate&&(r.push("Work Order Date"),s.push(25)),F.columns.amount&&(r.push("Amount"),s.push(20));const a=t.map((e=>{const t=[];return F.columns.workOrder&&t.push(k(e.work_order_num)),F.columns.phase&&t.push(e.job_phase?.job_phase_label||""),F.columns.property&&t.push(e.property.property_name),F.columns.unitNumber&&t.push(e.unit_number),F.columns.unitSize&&t.push(e.unit_size.unit_size_label),F.columns.jobType&&t.push(e.job_type.job_type_label),F.columns.scheduledDate&&t.push(N(e.scheduled_date)),F.columns.amount&&t.push(e.total_billing_amount?`$${e.total_billing_amount.toFixed(2)}`:"$0.00"),t})),o=Math.floor((e.internal.pageSize.getHeight()-20-10)/8);e.setFontSize(12),e.text(i,10,15);const d=t=>{t>0&&e.addPage(),e.setFontSize(8);let n=10;r.forEach(((t,r)=>{e.text(t,n,20),n+=s[r]}));const l=Math.min(t+o,a.length);for(let r=t;r<l;r++){const o=a[r];n=10,o.forEach(((a,o)=>{const l=a?.toString()||"",i=Math.floor(s[o]/1.5),d=l.length>i?l.substring(0,i-3)+"...":l;e.text(d,n,20+8*(r-t+1)),n+=s[o]}))}return l};let u=0;for(;u<a.length;)u=d(u);e.save(`${i.toLowerCase().replace(/\s+/g,"_")}_${n(new Date,"yyyy-MM-dd")}.pdf`)},oe=(le=v.filter((e=>e.property.property_name.toLowerCase().includes(R.toLowerCase())||e.unit_number.toLowerCase().includes(R.toLowerCase())||e.unit_size.unit_size_label.toLowerCase().includes(R.toLowerCase())||e.job_type.job_type_label.toLowerCase().includes(R.toLowerCase())||k(e.work_order_num).toLowerCase().includes(R.toLowerCase()))),[...le].sort(((e,t)=>{let r=0;const s="asc"===M.direction?1:-1;switch(M.field){case"work_order_num":r=e.work_order_num-t.work_order_num;break;case"job_phase":r=(e.job_phase?.job_phase_label||"").localeCompare(t.job_phase?.job_phase_label||"");break;case"property_name":r=e.property.property_name.localeCompare(t.property.property_name);break;case"unit_number":r=e.unit_number.localeCompare(t.unit_number);break;case"unit_size":r=e.unit_size.unit_size_label.localeCompare(t.unit_size.unit_size_label);break;case"job_type":r=e.job_type.job_type_label.localeCompare(t.job_type.job_type_label);break;case"scheduled_date":const s=l(e.scheduled_date),a=l(t.scheduled_date);r=s.getTime()-a.getTime();break;case"total_billing_amount":r=(e.total_billing_amount||0)-(t.total_billing_amount||0)}return r*s})));var le;const ie=({field:t})=>M.field!==t?e.jsx(f,{className:"ml-2 h-4 w-4 text-gray-400 group-hover:text-gray-700 dark:group-hover:text-white"}):"asc"===M.direction?e.jsx(w,{className:"ml-2 h-4 w-4 text-gray-900 dark:text-white"}):e.jsx(y,{className:"ml-2 h-4 w-4 text-gray-900 dark:text-white"});return C?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"p-6 bg-gray-100 dark:bg-[#0F172A] min-h-screen",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(h,{className:"h-8 w-8 text-gray-500 dark:text-gray-400"}),e.jsx("h1",{className:"text-2xl font-semibold text-gray-900 dark:text-white",children:i})]}),e.jsxs("div",{className:"flex space-x-3",children:[E&&e.jsxs("button",{onClick:async()=>{if(E){te(!0);try{await E(),t.success("Job list refreshed")}catch(e){t.error("Failed to refresh jobs. Please try again.")}finally{te(!1)}}},disabled:ee,className:"inline-flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-sm font-medium rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors disabled:opacity-50",children:[e.jsx(x,{className:"h-4 w-4 mr-2 "+(ee?"animate-spin":"")}),"Refresh"]}),W.length>0&&e.jsx(e.Fragment,{children:z?e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>H(!0),className:"inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors",children:[e.jsx(m,{className:"h-4 w-4 mr-2"}),"Unarchive Selected (",W.length,")"]}),e.jsxs("button",{onClick:()=>V(!0),className:"inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors",children:[e.jsx(b,{className:"h-4 w-4 mr-2"}),"Delete Selected (",W.length,")"]})]}):e.jsxs("button",{onClick:()=>Z(!0),className:"inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors",children:[e.jsx(m,{className:"h-4 w-4 mr-2"}),"Archive Selected (",W.length,")"]})}),D&&e.jsxs(a,{to:A,className:"inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors",children:[e.jsx(p,{className:"h-4 w-4 mr-2"}),"Add Job Request"]}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>J(!B),className:"inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors",children:[e.jsx(g,{className:"h-4 w-4 mr-2"}),"Export",e.jsx(y,{className:"h-4 w-4 ml-1"})]}),B&&e.jsxs("div",{className:"absolute right-0 mt-2 w-48 bg-white dark:bg-[#1E293B] rounded-lg shadow-lg z-10",children:[e.jsx("button",{onClick:()=>se("csv"),className:"w-full px-4 py-2 text-left text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-[#2D3B4E] rounded-t-lg",children:"Export as CSV"}),e.jsx("button",{onClick:()=>se("pdf"),className:"w-full px-4 py-2 text-left text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-[#2D3B4E] rounded-b-lg",children:"Export as PDF"})]})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(_,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:`Search ${i.toLowerCase()}...`,value:R,onChange:e=>$(e.target.value),className:"w-full pl-10 pr-4 py-2 bg-white dark:bg-[#1E293B] border border-gray-300 dark:border-[#1E293B] rounded-lg text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})}),S&&e.jsx("div",{className:"bg-red-50 dark:bg-red-900/50 border border-red-200 dark:border-red-500/50 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg",children:S}),e.jsx("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg overflow-hidden shadow",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-[#2D3B4E]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-3 py-4 text-left",children:e.jsx("div",{className:"flex items-center",children:e.jsx("input",{type:"checkbox",checked:W.length>0&&W.length===oe.length,onChange:e=>{e.target.checked?q(oe.map((e=>e.id))):q([])},className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"})})}),e.jsx("th",{scope:"col",className:"px-6 py-4 text-left",children:e.jsxs("button",{onClick:()=>re("work_order_num"),className:"group inline-flex items-center text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider hover:text-gray-700 dark:hover:text-white",children:["Work Order #",e.jsx(ie,{field:"work_order_num"})]})}),e.jsx("th",{scope:"col",className:"px-6 py-4 text-left",children:e.jsxs("button",{onClick:()=>re("job_phase"),className:"group inline-flex items-center text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider hover:text-gray-700 dark:hover:text-white",children:["Job Phase",e.jsx(ie,{field:"job_phase"})]})}),e.jsx("th",{scope:"col",className:"px-6 py-4 text-left",children:e.jsxs("button",{onClick:()=>re("property_name"),className:"group inline-flex items-center text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider hover:text-gray-700 dark:hover:text-white",children:["Property Name",e.jsx(ie,{field:"property_name"})]})}),e.jsx("th",{scope:"col",className:"px-6 py-4 text-left",children:e.jsxs("button",{onClick:()=>re("unit_number"),className:"group inline-flex items-center text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider hover:text-gray-700 dark:hover:text-white",children:["Unit #",e.jsx(ie,{field:"unit_number"})]})}),e.jsx("th",{scope:"col",className:"px-6 py-4 text-left",children:e.jsxs("button",{onClick:()=>re("unit_size"),className:"group inline-flex items-center text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider hover:text-gray-700 dark:hover:text-white",children:["Unit Size",e.jsx(ie,{field:"unit_size"})]})}),e.jsx("th",{scope:"col",className:"px-6 py-4 text-left",children:e.jsxs("button",{onClick:()=>re("job_type"),className:"group inline-flex items-center text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider hover:text-gray-700 dark:hover:text-white",children:["Job Type",e.jsx(ie,{field:"job_type"})]})}),e.jsx("th",{scope:"col",className:"px-6 py-4 text-left",children:e.jsxs("button",{onClick:()=>re("scheduled_date"),className:"group inline-flex items-center text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider hover:text-gray-700 dark:hover:text-white",children:["Scheduled Date",e.jsx(ie,{field:"scheduled_date"})]})}),e.jsx("th",{scope:"col",className:"px-6 py-4 text-left",children:e.jsxs("button",{onClick:()=>re("total_billing_amount"),className:"group inline-flex items-center text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider hover:text-gray-700 dark:hover:text-white",children:["Amount",e.jsx(ie,{field:"total_billing_amount"})]})})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-200 dark:divide-[#2D3B4E]",children:[oe.map((t=>e.jsxs("tr",{className:"hover:bg-gray-50/50 dark:hover:bg-[#2D3B4E]/30 transition-colors",children:[e.jsx("td",{className:"px-3 py-4",children:e.jsx("div",{className:"flex items-center",children:e.jsx("input",{type:"checkbox",checked:W.includes(t.id),onChange:()=>{return e=t.id,void q((t=>t.includes(e)?t.filter((t=>t!==e)):[...t,e]));var e},className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"})})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(a,{to:`/dashboard/jobs/${t.id}`,className:"text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 font-medium",children:k(t.work_order_num)})}),e.jsx("td",{className:"px-6 py-4",children:t.job_phase&&e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium",style:{backgroundColor:t.job_phase.color_dark_mode||"#4B5563",color:"white"},children:t.job_phase.job_phase_label})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(a,{to:`/dashboard/properties/${t.property.id}`,className:"text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400",children:t.property.property_name})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"text-gray-600 dark:text-gray-400",children:t.unit_number})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"text-gray-600 dark:text-gray-400",children:t.unit_size.unit_size_label})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"text-gray-600 dark:text-gray-400",children:t.job_type.job_type_label})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"text-gray-600 dark:text-gray-400",children:N(t.scheduled_date)})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"text-gray-600 dark:text-gray-400",children:t.total_billing_amount?`$${t.total_billing_amount.toFixed(2)}`:"$0.00"})})]},t.id))),0===oe.length&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"px-6 py-4 text-center text-gray-600 dark:text-gray-400",children:"No jobs found"})})]})]})})]}),Y&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 max-w-md w-full shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Archive Selected Jobs"}),e.jsxs("p",{className:"text-gray-700 dark:text-gray-300 mb-4",children:["Are you sure you want to archive ",W.length," selected job",1!==W.length?"s":"","? Archived jobs will be moved to the Archives section."]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx("button",{onClick:()=>Z(!1),className:"px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-400 bg-gray-100 dark:bg-[#2D3B4E] rounded-lg hover:bg-gray-200 dark:hover:bg-[#374151] transition-colors",children:"Cancel"}),e.jsx("button",{onClick:async()=>{if(0!==W.length){K(!0);try{const{data:e,error:s}=await r.from("job_phases").select("id").eq("job_phase_label","Archived").single();if(s){if("PGRST116"!==s.code)throw s;{const{data:e,error:t}=await r.from("job_phases").insert({job_phase_label:"Archived",color_light_mode:"#D4D4D8",color_dark_mode:"#52525B",sort_order:100,order_index:100}).select().single();if(t)throw t;if(!e)throw new Error("Failed to create Archived phase");const s=e,{data:a,error:n}=await r.auth.getUser();if(n)throw n;if(!a.user)throw new Error("User not found");const{data:o,error:l}=await r.from("jobs").select("id, current_phase_id").in("id",W);if(l)throw l;const{error:i}=await r.from("jobs").update({current_phase_id:s.id}).in("id",W);if(i)throw i;const d=o.map((e=>({job_id:e.id,changed_by:a.user.id,from_phase_id:e.current_phase_id,to_phase_id:s.id,change_reason:"Job archived"}))),{error:c}=await r.from("job_phase_changes").insert(d);if(c)throw c}}else{const{data:t,error:s}=await r.auth.getUser();if(s)throw s;if(!t.user)throw new Error("User not found");const{data:a,error:n}=await r.from("jobs").select("id, current_phase_id").in("id",W);if(n)throw n;const{error:o}=await r.from("jobs").update({current_phase_id:e.id}).in("id",W);if(o)throw o;const l=a.map((r=>({job_id:r.id,changed_by:t.user.id,from_phase_id:r.current_phase_id,to_phase_id:e.id,change_reason:"Job archived"}))),{error:i}=await r.from("job_phase_changes").insert(l);if(i)throw i}q([]),Z(!1),t.success(`Successfully archived ${W.length} job${1!==W.length?"s":""}`),E?await E():window.location.reload()}catch(e){t.error("Failed to archive jobs. Please try again.")}finally{K(!1)}}},disabled:Q,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50",children:Q?"Archiving...":"Archive Jobs"})]})]})}),G&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 max-w-md w-full shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Unarchive Selected Jobs"}),e.jsxs("p",{className:"text-gray-700 dark:text-gray-300 mb-4",children:["Are you sure you want to unarchive ",W.length," selected job",1!==W.length?"s":"","? Unarchived jobs will be moved back to the Job Requests section."]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx("button",{onClick:()=>H(!1),className:"px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-400 bg-gray-100 dark:bg-[#2D3B4E] rounded-lg hover:bg-gray-200 dark:hover:bg-[#374151] transition-colors",children:"Cancel"}),e.jsx("button",{onClick:async()=>{if(0!==W.length){K(!0);try{const{data:e,error:s}=await r.from("job_phases").select("id").eq("job_phase_label","Job Request").single();if(s)throw s;const{data:a,error:n}=await r.auth.getUser();if(n)throw n;if(!a.user)throw new Error("User not found");const{data:o,error:l}=await r.from("jobs").select("id, current_phase_id").in("id",W);if(l)throw l;const{error:i}=await r.from("jobs").update({current_phase_id:e.id}).in("id",W);if(i)throw i;const d=o.map((t=>({job_id:t.id,changed_by:a.user.id,from_phase_id:t.current_phase_id,to_phase_id:e.id,change_reason:"Job unarchived"}))),{error:c}=await r.from("job_phase_changes").insert(d);if(c)throw c;q([]),H(!1),t.success(`Successfully unarchived ${W.length} job${1!==W.length?"s":""}`),E?await E():window.location.reload()}catch(e){t.error("Failed to unarchive jobs. Please try again.")}finally{K(!1)}}},disabled:Q,className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50",children:Q?"Unarchiving...":"Unarchive Jobs"})]})]})}),X&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 max-w-md w-full shadow-xl",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"Delete Selected Jobs"}),e.jsxs("p",{className:"text-gray-700 dark:text-gray-300 mb-4",children:["Are you sure you want to permanently delete ",W.length," selected job",1!==W.length?"s":"","? This action cannot be undone."]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx("button",{onClick:()=>V(!1),className:"px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-400 bg-gray-100 dark:bg-[#2D3B4E] rounded-lg hover:bg-gray-200 dark:hover:bg-[#374151] transition-colors",children:"Cancel"}),e.jsx("button",{onClick:async()=>{if(0!==W.length){K(!0);try{const{data:e,error:s}=await r.from("jobs").select("\n          id,\n          current_phase_id,\n          job_phases!current_phase_id (\n            job_phase_label\n          )\n        ").in("id",W);if(s)throw s;if(e.filter((e=>{const t=e.job_phases?.job_phase_label;return"Archived"!==t})).length>0)return void t.error("Only archived jobs can be deleted");const a=u("https://tbwtfimnbmvbgesidbxh.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRid3RmaW1uYm12Ymdlc2lkYnhoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MDEyOTA3OSwiZXhwIjoyMDY1NzA1MDc5fQ.6H9yeEtrq_kf8DkrQXSHCHlo-erE_gso715qAwsDKmU",{auth:{autoRefreshToken:!1,persistSession:!1}}),{error:n,count:o}=await a.from("work_orders").delete({count:"exact"}).in("job_id",W);if(n)throw new Error(`Failed to delete work orders: ${n.message}`);const{error:l,count:i}=await a.from("files").delete({count:"exact"}).in("job_id",W);if(l)throw new Error(`Failed to delete files: ${l.message}`);const{error:d,count:c}=await a.from("jobs").delete({count:"exact"}).in("id",W);if(d)throw new Error(`Failed to delete jobs: ${d.message}`);const{data:h,error:x}=await a.from("jobs").select("id").in("id",W);if(x);else if(h&&h.length>0)throw new Error(`Deletion failed: ${h.length} jobs still exist in database`);E?await E():window.location.reload(),q([]),V(!1),t.success("Selected jobs deleted successfully")}catch(e){t.error(e instanceof Error?e.message:"Failed to delete jobs")}finally{K(!1)}}},disabled:Q,className:"px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50",children:Q?"Deleting...":"Delete Jobs"})]})]})}),U&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 max-w-2xl w-full shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Export Configuration"}),e.jsx("button",{onClick:()=>O(!1),className:"text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",children:e.jsx(j,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-3",children:"Date Range"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600 dark:text-gray-400 mb-1",children:"Start Date"}),e.jsx("input",{type:"date",value:F.dateRange.startDate,onChange:e=>L((t=>({...t,dateRange:{...t.dateRange,startDate:e.target.value}}))),className:"w-full px-3 py-2 bg-white dark:bg-[#2D3B4E] border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-gray-600 dark:text-gray-400 mb-1",children:"End Date"}),e.jsx("input",{type:"date",value:F.dateRange.endDate,onChange:e=>L((t=>({...t,dateRange:{...t.dateRange,endDate:e.target.value}}))),className:"w-full px-3 py-2 bg-white dark:bg-[#2D3B4E] border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white"})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-3",children:"Columns to Include"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:F.columns.workOrder,onChange:e=>L((t=>({...t,columns:{...t.columns,workOrder:e.target.checked}}))),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Work Order #"})]}),e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:F.columns.phase,onChange:e=>L((t=>({...t,columns:{...t.columns,phase:e.target.checked}}))),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Phase"})]}),e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:F.columns.property,onChange:e=>L((t=>({...t,columns:{...t.columns,property:e.target.checked}}))),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Property"})]}),e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:F.columns.address,onChange:e=>L((t=>({...t,columns:{...t.columns,address:e.target.checked}}))),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Address"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:F.columns.unitNumber,onChange:e=>L((t=>({...t,columns:{...t.columns,unitNumber:e.target.checked}}))),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Unit #"})]}),e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:F.columns.unitSize,onChange:e=>L((t=>({...t,columns:{...t.columns,unitSize:e.target.checked}}))),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Unit Size"})]}),e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:F.columns.jobType,onChange:e=>L((t=>({...t,columns:{...t.columns,jobType:e.target.checked}}))),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Job Type"})]}),e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:F.columns.scheduledDate,onChange:e=>L((t=>({...t,columns:{...t.columns,scheduledDate:e.target.checked}}))),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Work Order Date"})]}),e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:F.columns.amount,onChange:e=>L((t=>({...t,columns:{...t.columns,amount:e.target.checked}}))),className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),e.jsx("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Amount"})]})]})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx("button",{onClick:()=>O(!1),className:"px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-400 bg-gray-100 dark:bg-[#2D3B4E] rounded-lg hover:bg-gray-200 dark:hover:bg-[#374151] transition-colors",children:"Cancel"}),e.jsxs("button",{onClick:()=>{"csv"===T?ae():"pdf"===T&&ne(),O(!1)},className:"px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors",children:["Export ",T?.toUpperCase()]})]})]})})]})}function C({phaseLabel:e}){const[t,a]=s.useState([]),[n,o]=s.useState(!0),[l,i]=s.useState(null),[d,c]=s.useState([]),u=s.useRef(!0),h=s.useRef(null),x=s.useRef(0),m=s.useCallback((async(t=!1)=>{const s=Date.now();if(t||!(s-x.current<5e3)){x.current=s,h.current&&h.current.abort(),h.current=new AbortController;try{const{data:t,error:s}=await r.from("job_phases").select("id").in("job_phase_label",Array.isArray(e)?e:[e]);if(s)throw s;if(!t?.length)throw new Error(`${e} phase not found`);u.current&&c(t.map((e=>e.id)));let n="created_at",o=!1;"Job Request"===e||Array.isArray(e)&&e.includes("Job Request")?(n="created_at",o=!1):("Work Order"===e||"Pending Work Order"===e||"Grading"===e||"Invoicing"===e||Array.isArray(e)&&(e.includes("Work Order")||e.includes("Pending Work Order")||e.includes("Grading")||e.includes("Invoicing")))&&(n="updated_at",o=!1);const{data:l,error:d}=await r.from("jobs").select("\n          id,\n          work_order_num,\n          unit_number,\n          scheduled_date,\n          total_billing_amount,\n          property:properties (\n            id,\n            property_name,\n            address,\n            city,\n            state\n          ),\n          unit_size:unit_sizes (\n            unit_size_label\n          ),\n          job_type:job_types (\n            job_type_label\n          ),\n          job_phase:current_phase_id (\n            job_phase_label,\n            color_light_mode,\n            color_dark_mode\n          )\n        ").in("current_phase_id",t.map((e=>e.id))).order(n,{ascending:o});if(d)throw d;if(u.current){const e=(l||[]).map((e=>({id:e.id,work_order_num:e.work_order_num,unit_number:e.unit_number,scheduled_date:e.scheduled_date,total_billing_amount:e.total_billing_amount,property:Array.isArray(e.property)?e.property[0]:e.property,unit_size:Array.isArray(e.unit_size)?e.unit_size[0]:e.unit_size,job_type:Array.isArray(e.job_type)?e.job_type[0]:e.job_type,job_phase:Array.isArray(e.job_phase)?e.job_phase[0]:e.job_phase})));a(e),i(null)}}catch(n){u.current&&i(n instanceof Error?n.message:"Failed to fetch jobs")}finally{u.current&&o(!1)}}}),[e]);return s.useEffect((()=>(u.current=!0,m(),()=>{u.current=!1,h.current&&h.current.abort()})),[m]),s.useEffect((()=>{if(0===d.length)return;const e=r.channel("jobs-changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"jobs",filter:`current_phase_id=in.(${d.join(",")})`},(async e=>{if(u.current){const{data:t,error:s}=await r.from("jobs").select("\n              id,\n              work_order_num,\n              unit_number,\n              scheduled_date,\n              total_billing_amount,\n              property:properties (\n                id,\n                property_name,\n                address,\n                city,\n                state\n              ),\n              unit_size:unit_sizes (\n                unit_size_label\n              ),\n              job_type:job_types (\n                job_type_label\n              ),\n              job_phase:current_phase_id (\n                job_phase_label,\n                color_light_mode,\n                color_dark_mode\n              )\n            ").eq("id",e.new.id).single();if(!s&&t){const e={id:t.id,work_order_num:t.work_order_num,unit_number:t.unit_number,scheduled_date:t.scheduled_date,total_billing_amount:t.total_billing_amount,property:Array.isArray(t.property)?t.property[0]:t.property,unit_size:Array.isArray(t.unit_size)?t.unit_size[0]:t.unit_size,job_type:Array.isArray(t.job_type)?t.job_type[0]:t.job_type,job_phase:Array.isArray(t.job_phase)?t.job_phase[0]:t.job_phase};a((t=>[e,...t]))}else m(!0)}})).on("postgres_changes",{event:"UPDATE",schema:"public",table:"jobs"},(async e=>{u.current&&setTimeout((()=>m(!0)),500)})).on("postgres_changes",{event:"INSERT",schema:"public",table:"job_phase_changes"},(async e=>{u.current&&setTimeout((()=>m(!0)),1e3)})).on("postgres_changes",{event:"DELETE",schema:"public",table:"jobs"},(e=>{u.current&&a((t=>t.filter((t=>t.id!==e.old.id))))})).subscribe();return()=>{e.unsubscribe()}}),[d,m]),{jobs:t,loading:n,error:l,refetch:()=>m(!0)}}export{v as J,C as u};

import{s as e,b as r,j as a}from"./index-DSvJvUB2.js";import{u as t,r as s}from"./react-vendor-BmeRVKJv.js";import{q as l,i as n,N as o,v as i,f as d,X as c,ah as m,ai as x,E as u}from"./ui-CiwSAYI4.js";import"./supabase-c3qFLfUQ.js";function h(){const h=t(),[g,b]=s.useState(!0),[f,y]=s.useState(!1),[p,k]=s.useState(null),[j,w]=s.useState(null),[v,N]=s.useState(null),[_,E]=s.useState(null),C=s.useRef(null),[S,F]=s.useState({id:"",email:"",full_name:"",nickname:"",avatar_url:null,mobile_phone:"",sms_phone:"",bio:"",role:"user",username:"",theme_preference:"dark",work_schedule:[],notification_settings:null}),[B,D]=s.useState({job_phase_changes:!0,work_orders:!0,callbacks:!0,system_alerts:!0}),[P,R]=s.useState(null);s.useEffect((()=>{U()}),[]),s.useEffect((()=>{if(S.notification_settings)try{const e=JSON.parse(S.notification_settings);D(e)}catch(e){}}),[S.notification_settings]);const U=async()=>{try{b(!0);const{data:r,error:t}=await e.auth.getUser();if(t)throw t;if(!r.user)throw new Error("User not found");const{data:s,error:l}=await e.from("profiles").select("*").eq("id",r.user.id).single();if(l){if("PGRST116"!==l.code)throw l;{const a={id:r.user.id,email:r.user.email,full_name:r.user.user_metadata?.full_name||"",role:"user",theme_preference:"dark",work_schedule:["Monday","Tuesday","Wednesday","Thursday","Friday"],notification_settings:JSON.stringify({job_phase_changes:!0,work_orders:!0,callbacks:!0,system_alerts:!0})},{error:t}=await e.from("profiles").insert([a]);if(t)throw t;F(a),D({job_phase_changes:!0,work_orders:!0,callbacks:!0,system_alerts:!0})}}else if(s){if(F({...s,work_schedule:s.work_schedule||[]}),s.avatar_url){const{data:{publicUrl:r}}=e.storage.from("avatars").getPublicUrl(s.avatar_url);w(r)}if(s.notification_settings)try{const e=JSON.parse(s.notification_settings);D(e)}catch(a){D({job_phase_changes:!0,work_orders:!0,callbacks:!0,system_alerts:!0})}else D({job_phase_changes:!0,work_orders:!0,callbacks:!0,system_alerts:!0})}const n="https://portal.jgpaintingprosinc.com",{data:{session:o}}=await e.auth.getSession(),i=o?.access_token||"",d=`${n}/functions/v1/calendar-feed?userId=${r.user.id}&token=${encodeURIComponent(i)}`;R(d)}catch(t){k(t instanceof Error?t.message:"Failed to load profile"),r.error("Failed to load profile")}finally{b(!1)}},A=()=>{C.current&&C.current.click()},O=e=>{const{name:r,value:a}=e.target;F((e=>({...e,[r]:a})))},I=e=>{D((r=>({...r,[e]:!r[e]})))};return g?a.jsx("div",{className:"flex items-center justify-center h-full",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):a.jsx("div",{className:"p-6 bg-gray-100 dark:bg-[#0F172A] min-h-screen",children:a.jsxs("div",{className:"max-w-4xl mx-auto",children:[a.jsx("div",{className:"flex items-center justify-between mb-8",children:a.jsxs("div",{className:"flex items-center space-x-3",children:[a.jsx(l,{className:"h-8 w-8 text-gray-600 dark:text-gray-400"}),a.jsx("h1",{className:"text-2xl font-semibold text-gray-900 dark:text-white",children:"User Profile"})]})}),p&&a.jsx("div",{className:"mb-6 bg-red-50 dark:bg-red-900/50 border border-red-200 dark:border-red-500/50 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg",children:p}),a.jsxs("form",{onSubmit:async a=>{a.preventDefault(),y(!0),k(null);try{let a=S.avatar_url;if(v){const r=v.name.split(".").pop(),t=`${S.id}-${Date.now()}.${r}`,{error:s}=await e.storage.from("avatars").upload(t,v,{upsert:!0});if(s)throw s;a=t}const{error:t}=await e.from("profiles").update({full_name:S.full_name,nickname:S.nickname,avatar_url:a,mobile_phone:S.mobile_phone,sms_phone:S.sms_phone,bio:S.bio,username:S.username,work_schedule:S.work_schedule,notification_settings:JSON.stringify(B)}).eq("id",S.id);if(t)throw t;r.success("Profile updated successfully"),U()}catch(t){k(t instanceof Error?t.message:"Failed to update profile"),r.error("Failed to update profile")}finally{y(!1)}},className:"space-y-6",children:[a.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 shadow",children:[a.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-6",children:"Profile Picture"}),a.jsxs("div",{className:"flex flex-col items-center",children:[a.jsx("div",{className:"w-32 h-32 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center overflow-hidden cursor-pointer border-4 border-gray-300 dark:border-gray-600 hover:border-blue-500 dark:hover:border-blue-500 transition-colors",onClick:A,children:_?a.jsx("img",{src:_,alt:"Avatar Preview",className:"w-full h-full object-cover"}):j?a.jsx("img",{src:j,alt:"User Avatar",className:"w-full h-full object-cover"}):a.jsx(l,{className:"h-16 w-16 text-gray-400 dark:text-gray-500"})}),a.jsx("input",{type:"file",ref:C,onChange:e=>{if(e.target.files&&e.target.files[0]){const a=e.target.files[0];if(a.size>2097152)return void r.error("Image is too large. Maximum size is 2MB.");if(!a.type.startsWith("image/"))return void r.error("Only image files are allowed.");N(a);const t=new FileReader;t.onload=e=>{E(e.target?.result)},t.readAsDataURL(a)}},accept:"image/*",className:"hidden"}),a.jsxs("button",{type:"button",onClick:A,className:"mt-4 text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 flex items-center",children:[a.jsx(n,{className:"h-4 w-4 mr-1"}),S.avatar_url?"Change Photo":"Upload Photo"]}),(S.avatar_url||_)&&a.jsxs("button",{type:"button",onClick:()=>{w(null),E(null),N(null),F((e=>({...e,avatar_url:null})))},className:"mt-2 text-sm text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 flex items-center",children:[a.jsx(o,{className:"h-4 w-4 mr-1"}),"Remove Photo"]})]})]}),a.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 shadow",children:[a.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-6",children:"Basic Information"}),a.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2",children:[a.jsxs("div",{children:[a.jsx("label",{htmlFor:"full_name",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Full Name"}),a.jsx("input",{type:"text",id:"full_name",name:"full_name",value:S.full_name||"",onChange:O,className:"w-full h-11 px-4 bg-gray-50 dark:bg-[#0F172A] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter your full name"})]}),a.jsxs("div",{children:[a.jsx("label",{htmlFor:"nickname",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Nickname"}),a.jsx("input",{type:"text",id:"nickname",name:"nickname",value:S.nickname||"",onChange:O,className:"w-full h-11 px-4 bg-gray-50 dark:bg-[#0F172A] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter your nickname"})]}),a.jsxs("div",{children:[a.jsx("label",{htmlFor:"username",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Username"}),a.jsx("input",{type:"text",id:"username",name:"username",value:S.username||"",onChange:O,className:"w-full h-11 px-4 bg-gray-50 dark:bg-[#0F172A] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter your username"})]}),a.jsxs("div",{children:[a.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Email Address"}),a.jsx("input",{type:"email",id:"email",name:"email",value:S.email,readOnly:!0,className:"w-full h-11 px-4 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-500 dark:text-gray-400 cursor-not-allowed"}),a.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Email cannot be changed"})]}),a.jsxs("div",{children:[a.jsx("label",{htmlFor:"mobile_phone",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Mobile Phone"}),a.jsx("input",{type:"tel",id:"mobile_phone",name:"mobile_phone",value:S.mobile_phone||"",onChange:O,className:"w-full h-11 px-4 bg-gray-50 dark:bg-[#0F172A] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter your mobile phone"})]}),a.jsxs("div",{children:[a.jsx("label",{htmlFor:"sms_phone",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"SMS Phone"}),a.jsx("input",{type:"tel",id:"sms_phone",name:"sms_phone",value:S.sms_phone||"",onChange:O,className:"w-full h-11 px-4 bg-gray-50 dark:bg-[#0F172A] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter your SMS phone"})]}),a.jsxs("div",{className:"md:col-span-2",children:[a.jsx("label",{htmlFor:"bio",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Bio / About"}),a.jsx("textarea",{id:"bio",name:"bio",rows:4,value:S.bio||"",onChange:O,className:"w-full px-4 py-3 bg-gray-50 dark:bg-[#0F172A] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Tell us about yourself"})]})]})]}),a.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 shadow",children:[a.jsxs("div",{className:"flex items-center mb-6",children:[a.jsx(i,{className:"h-5 w-5 text-gray-500 dark:text-gray-400 mr-2"}),a.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Notification Settings"})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:"Job Phase Changes"}),a.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Receive notifications when a job changes phase"})]}),a.jsx("div",{className:"w-12 h-6 rounded-full flex items-center p-1 cursor-pointer transition-colors "+(B.job_phase_changes?"bg-blue-600":"bg-gray-300 dark:bg-gray-700"),onClick:()=>I("job_phase_changes"),children:a.jsx("div",{className:"w-4 h-4 rounded-full bg-white transform transition-transform "+(B.job_phase_changes?"translate-x-6":"translate-x-0")})})]}),a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:"Work Order Updates"}),a.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Receive notifications about work order updates"})]}),a.jsx("div",{className:"w-12 h-6 rounded-full flex items-center p-1 cursor-pointer transition-colors "+(B.work_orders?"bg-blue-600":"bg-gray-300 dark:bg-gray-700"),onClick:()=>I("work_orders"),children:a.jsx("div",{className:"w-4 h-4 rounded-full bg-white transform transition-transform "+(B.work_orders?"translate-x-6":"translate-x-0")})})]}),a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:"Callbacks"}),a.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Receive notifications about property callbacks"})]}),a.jsx("div",{className:"w-12 h-6 rounded-full flex items-center p-1 cursor-pointer transition-colors "+(B.callbacks?"bg-blue-600":"bg-gray-300 dark:bg-gray-700"),onClick:()=>I("callbacks"),children:a.jsx("div",{className:"w-4 h-4 rounded-full bg-white transform transition-transform "+(B.callbacks?"translate-x-6":"translate-x-0")})})]}),a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:"System Alerts"}),a.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:"Receive important system notifications and alerts"})]}),a.jsx("div",{className:"w-12 h-6 rounded-full flex items-center p-1 cursor-pointer transition-colors "+(B.system_alerts?"bg-blue-600":"bg-gray-300 dark:bg-gray-700"),onClick:()=>I("system_alerts"),children:a.jsx("div",{className:"w-4 h-4 rounded-full bg-white transform transition-transform "+(B.system_alerts?"translate-x-6":"translate-x-0")})})]})]})]}),a.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 shadow",children:[a.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-6",children:"Role and Preferences"}),a.jsxs("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2",children:[a.jsxs("div",{children:[a.jsx("label",{htmlFor:"role",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Role"}),a.jsx("input",{type:"text",id:"role",name:"role",value:S.role,readOnly:!0,className:"w-full h-11 px-4 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-500 dark:text-gray-400 cursor-not-allowed"}),a.jsx("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Role can only be changed by an admin"})]}),a.jsxs("div",{children:[a.jsx("label",{htmlFor:"theme_preference",className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Theme Preference"}),a.jsxs("select",{id:"theme_preference",name:"theme_preference",value:S.theme_preference||"dark",onChange:O,className:"w-full h-11 px-4 bg-gray-50 dark:bg-[#0F172A] border border-gray-300 dark:border-[#2D3B4E] rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500",children:[a.jsx("option",{value:"light",children:"Light"}),a.jsx("option",{value:"dark",children:"Dark"}),a.jsx("option",{value:"system",children:"System Default"})]})]})]})]}),"subcontractor"===S.role&&a.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 shadow",children:[a.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-6",children:"Work Schedule Availability"}),a.jsx("div",{className:"grid grid-cols-5 gap-4",children:["Monday","Tuesday","Wednesday","Thursday","Friday"].map((e=>a.jsxs("div",{className:"flex flex-col items-center",children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:e}),a.jsx("div",{className:"w-12 h-12 rounded-lg flex items-center justify-center cursor-pointer transition-colors "+(S.work_schedule?.includes(e)?"bg-blue-600 text-white":"bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400"),onClick:()=>(e=>{F((r=>{const a=r.work_schedule||[];return a.includes(e)?{...r,work_schedule:a.filter((r=>r!==e))}:{...r,work_schedule:[...a,e]}}))})(e),children:S.work_schedule?.includes(e)?a.jsx(d,{className:"h-6 w-6"}):a.jsx(c,{className:"h-6 w-6"})})]},e)))})]}),a.jsxs("div",{className:"bg-white dark:bg-[#1E293B] rounded-lg p-6 shadow",children:[a.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-6",children:"Calendar Sync"}),a.jsx("div",{className:"space-y-4",children:a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Your Personal Calendar (ICS)"}),a.jsxs("div",{className:"flex items-center",children:[a.jsx("input",{type:"text",value:P||"",readOnly:!0,className:"flex-1 h-11 px-4 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-[#2D3B4E] rounded-l-lg text-gray-500 dark:text-gray-400 cursor-not-allowed"}),a.jsx("button",{type:"button",onClick:()=>{P&&navigator.clipboard.writeText(P).then((()=>r.success("Calendar URL copied to clipboard"))).catch((()=>r.error("Failed to copy URL")))},className:"h-11 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-r-lg transition-colors",children:a.jsx(m,{className:"h-5 w-5"})})]}),a.jsx("p",{className:"mt-1 text-sm text-gray-600 dark:text-gray-400",children:"Use this link to sync your assigned jobs with your calendar app"}),a.jsx("div",{className:"mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800/30 rounded-lg",children:a.jsxs("div",{className:"flex items-start",children:[a.jsx(x,{className:"h-5 w-5 text-blue-500 mr-2 mt-0.5"}),a.jsxs("div",{children:[a.jsx("p",{className:"text-sm text-blue-800 dark:text-blue-200",children:"Calendar Integration Instructions"}),a.jsxs("ol",{className:"mt-2 text-sm text-blue-700 dark:text-blue-300 list-decimal pl-5 space-y-1",children:[a.jsx("li",{children:"Copy the URL above"}),a.jsx("li",{children:"In your calendar app, add a new calendar subscription"}),a.jsx("li",{children:"Paste the URL when prompted for the calendar address"}),a.jsx("li",{children:"Set auto-refresh to daily for best results"}),a.jsx("li",{children:"Your assigned jobs will appear in your calendar"})]})]})]})})]})})]}),a.jsxs("div",{className:"flex justify-end space-x-3",children:[a.jsx("button",{type:"button",onClick:()=>h("/dashboard"),className:"px-6 py-2 text-sm font-medium text-gray-700 dark:text-gray-400 bg-white dark:bg-[#1E293B] border border-gray-300 dark:border-[#2D3B4E] rounded-lg hover:bg-gray-50 dark:hover:bg-[#2D3B4E] transition-colors",children:"Cancel"}),a.jsx("button",{type:"submit",disabled:f,className:"px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 flex items-center",children:f?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"}),"Saving..."]}):a.jsxs(a.Fragment,{children:[a.jsx(u,{className:"h-4 w-4 mr-2"}),"Save Changes"]})})]})]})]})})}export{h as UserProfile};
